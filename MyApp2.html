<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniVerse (UV)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --accent: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --lecturer: #9b59b6;
            --admin: #1abc9c;
            --available: #2ecc71;
            --unavailable: #e74c3c;
            --cancelled: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-title i {
            font-size: 2.2rem;
        }

        .app-title h1 {
            font-weight: 700;
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-details {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .user-role {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Navigation Styles */
        .tabs {
            display: flex;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
            color: var(--dark);
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background-color: var(--primary);
            color: white;
            border-bottom: 3px solid var(--secondary);
        }

        .tab:hover:not(.active) {
            background-color: #f5f7fa;
            border-bottom: 3px solid var(--primary);
        }

        /* Content Sections */
        .content-section {
            display: none;
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .content-section.active {
            display: block;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--secondary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dashboard-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed #e0e6ed;
        }

        .stat-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        /* Chat Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-header {
            padding: 15px 20px;
            background-color: var(--primary);
            color: white;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .online-users {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-count {
            background-color: var(--success);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .whatsapp-link {
            background-color: #25D366;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .whatsapp-link:hover {
            background-color: #128C7E;
            transform: translateY(-2px);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #fafbfc;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 75%;
        }

        .message-content {
            padding: 12px 18px;
            border-radius: 18px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .message.received .message-content {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-top-left-radius: 5px;
        }

        .message.sent {
            align-items: flex-end;
            align-self: flex-end;
        }

        .message.sent .message-content {
            background-color: var(--primary);
            color: white;
            border-top-right-radius: 5px;
        }

        .message-info {
            font-size: 0.8rem;
            color: #777;
            margin-top: 5px;
            padding: 0 5px;
        }

        /* Conversations / inbox */
        #conversations-list .conv-item {
            display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;margin-bottom:6px;cursor:pointer;border:1px solid transparent;
        }
        #conversations-list .conv-item:hover { background:#f7fbff;border-color:#e6f0ff; }
        #conversations-list .conv-item .conv-avatar { width:36px;height:36px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:700 }
        #conversations-list .conv-item .conv-meta { flex:1 }
        #conversations-list .conv-item .conv-title { font-weight:600 }
        #conversations-list .conv-item .conv-sub { font-size:0.85rem;color:#666 }

        /* Unread badge */
        .private-unread-badge {
            position: absolute; right:10px; top:8px; background:#ff4757;color:white;border-radius:12px;padding:2px 6px;font-size:0.75rem;display:none;align-items:center;justify-content:center;min-width:22px;text-align:center
        }

    /* Emoji picker */
    #emoji-cats { display:flex; gap:6px; }
    .emoji-cat { padding:6px 8px; background:#f6f8fb; border-radius:8px; cursor:pointer; font-size:0.9rem; color:#333 }
    .emoji-cat.active { background:var(--primary); color:white }
    #emoji-grid .emoji-item { cursor:pointer; font-size:18px; display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:6px }
    #emoji-grid .emoji-item:hover { background:#f0f4fb }
    #emoji-recent-list .emoji-item { margin-left:6px }

        /* Reactions under messages */
        .reactions { display:flex; gap:6px; margin-top:6px }
        .reaction { background:#f1f3f8;border:1px solid #e6e9f2;padding:2px 6px;border-radius:12px;font-size:0.85rem;display:inline-flex;align-items:center;gap:6px;cursor:pointer }
        .reaction .count { font-weight:600; color:#333 }

        /* Typing indicator */
        #typing-indicator { font-style:italic; color:#3a3f47 }

        .message-actions {
            position: absolute;
            top: -10px;
            right: 10px;
            display: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 5px;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action {
            padding: 5px;
            cursor: pointer;
            color: var(--primary);
        }

        .file-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background-color: #f0f4f8;
            border-radius: 10px;
            margin-top: 8px;
            border: 1px solid #e0e6ed;
        }

        .file-icon {
            font-size: 2rem;
            color: var(--primary);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .file-size {
            font-size: 0.8rem;
            color: #777;
        }

        .file-download {
            color: var(--primary);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .chat-input {
            display: flex;
            padding: 18px;
            background-color: white;
            border-top: 1px solid #e0e6ed;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            gap: 12px;
        }

        .chat-input input {
            flex: 1;
            padding: 14px;
            border: 1px solid #e0e6ed;
            border-radius: 25px;
            outline: none;
            font-size: 1rem;
        }

        .chat-input-actions {
            display: flex;
            gap: 12px;
        }

        .chat-input button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-input button:hover {
            background-color: var(--secondary);
            transform: scale(1.05);
        }

        /* User list for private messaging */
        .user-list {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .user-list h3 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            position: relative; /* allow absolute-positioned badges */
        }

        .user-item:hover {
            background-color: #e9ecef;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success);
            margin-left: auto;
        }

        /* Timetable Styles */
        .timetable-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }

        .timetable-actions {
            display: flex;
            gap: 12px;
        }

        .timetable-actions button {
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #1e2a36;
        }

        .timetable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .timetable th, .timetable td {
            border: 1px solid #e0e6ed;
            padding: 15px;
            text-align: center;
        }

        .timetable th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }

        .timetable td {
            background-color: #fff;
            position: relative;
        }

        .timetable .time-cell {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
        }

        .class-cell {
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .class-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .class-cell.available {
            background-color: var(--available);
        }

        .class-cell.unavailable {
            background-color: var(--unavailable);
            opacity: 0.7;
        }

        .class-cell.cancelled {
            background-color: var(--cancelled);
        }

        .class-cell.makeup {
            background: linear-gradient(135deg, var(--warning), var(--primary));
        }

        .class-info {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .class-status {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* Lecturer Controls */
        .lecturer-controls {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e0e6ed;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e6ed;
            border-radius: 5px;
            outline: none;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Results Portal Styles */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e6ed;
        }

        .semester-select {
            padding: 10px 15px;
            border: 1px solid #e0e6ed;
            border-radius: 5px;
            outline: none;
            font-size: 1rem;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .results-table th, .results-table td {
            border: 1px solid #e0e6ed;
            padding: 15px;
            text-align: left;
        }

        .results-table th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }

        .results-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .results-table tr:hover {
            background-color: #eef5ff;
        }

        .grade {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            text-align: center;
            min-width: 40px;
        }

        .grade.a {
            background-color: var(--success);
            color: white;
        }

        .grade.b {
            background-color: #3498db;
            color: white;
        }

        .grade.c {
            background-color: var(--warning);
            color: white;
        }

        .grade.f {
            background-color: var(--danger);
            color: white;
        }

        .stats-box {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #e0e6ed;
        }

        .stats-box h3 {
            margin-bottom: 15px;
            color: var(--primary);
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e6ed;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed #e0e6ed;
        }

        .stat-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        /* Admin Section */
        .admin-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            border: 1px solid #e0e6ed;
        }

        /* Login Form */
        .login-container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            margin: 50px auto;
            max-width: 450px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
        }

        .login-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .login-header h2 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .login-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .login-option {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: 2px solid #e0e6ed;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .login-option.active {
            border-color: var(--primary);
            background-color: var(--primary);
            color: white;
        }

        /* Registration Form */
        .registration-form {
            display: none;
        }

        .error-message {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }
        
        .form-group.error input, 
        .form-group.error select {
            border-color: var(--danger);
        }
        
        .form-group.error .error-message {
            display: block;
        }

        /* Resources Section */
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .resource-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .resource-icon {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 15px;
            text-align: center;
        }

        .resource-name {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .resource-info {
            font-size: 0.9rem;
            color: #777;
            margin-bottom: 15px;
        }

        .resource-actions {
            display: flex;
            justify-content: space-between;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .chat-container {
                height: 500px;
            }
            
            .timetable {
                font-size: 0.8rem;
            }
            
            .timetable th, .timetable td {
                padding: 8px;
            }
            
            .message {
                max-width: 90%;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-info {
                flex-direction: column;
            }
            
            .user-details {
                text-align: center;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-available {
            background-color: var(--available);
        }

        .status-unavailable {
            background-color: var(--unavailable);
        }

        .status-cancelled {
            background-color: var(--cancelled);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e6ed;
        }

        .modal-title {
            font-size: 1.4rem;
            color: var(--dark);
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        /* Notification Bell */
        .notification-bell {
            position: relative;
            cursor: pointer;
            margin-left: 20px;
        }

        /* Private message unread badge on user items */
        .private-unread-badge {
            position: absolute;
            right: 8px;
            top: 10px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Calendar View */
        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-day {
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .calendar-day:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        .calendar-day.current {
            background-color: var(--primary);
            color: white;
        }

        .calendar-day.has-class {
            border: 2px solid var(--success);
        }

        .day-name {
            font-size: 0.8rem;
            color: #777;
            margin-bottom: 5px;
        }

        .day-number {
            font-size: 1.2rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
        <div class="container" id="login-container">
        <!-- Login Form -->
        <div class="login-container" id="login-form">
            <div class="login-header">
                <h2><i class="fas fa-graduation-cap"></i> UniVerse (UV)</h2>
                <p>Sign in to access your account</p>
            </div>
            
            <div class="login-options">
                <div class="login-option active" data-role="student">Student</div>
                <div class="login-option" data-role="lecturer">Lecturer</div>
                <div class="login-option" data-role="admin">Admin</div>
            </div>
            
            <div class="form-group">
                <label for="login-username">ID Number</label>
                <input type="text" id="login-username" placeholder="Enter your ID number">
            </div>
            
            <div class="form-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" placeholder="Enter your password">
            </div>
            
            <div class="form-group">
                <button class="btn-primary" style="width: 100%; padding: 14px;" id="login-btn">Sign In</button>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <a href="#" id="show-register" style="color: var(--primary); text-decoration: none;">Create Account</a>
            </div>
        </div>

        <!-- Registration Form -->
        <div class="login-container" id="registration-container" style="display: none;">
            <div class="login-header">
                <h2><i class="fas fa-user-plus"></i> Create Account</h2>
                <p>Register for UniVerse (UV)</p>
            </div>
            
            <div class="form-group">
                <label for="reg-fullname">Full Name</label>
                <input type="text" id="reg-fullname" placeholder="Enter your full name">
                <div class="error-message" id="reg-fullname-error">Please enter your full name</div>
            </div>
            
            <div class="form-group">
                <label for="reg-id">ID Number</label>
                <input type="text" id="reg-id" placeholder="Enter your ID number">
                <div class="error-message" id="reg-id-error">Please enter a valid ID number</div>
            </div>
            
            <div class="form-group">
                <label for="reg-email">Email Address</label>
                <input type="email" id="reg-email" placeholder="Enter your email address">
                <div class="error-message" id="reg-email-error">Please enter a valid email address</div>
            </div>
            
            <div class="form-group">
                <label for="reg-program">Program of Study</label>
                <select id="reg-program">
                    <option value="">Select Program</option>
                    <option value="cs">Computer Science</option>
                    <option value="eng">Engineering</option>
                    <option value="bus">Business Administration</option>
                    <option value="med">Medicine</option>
                    <option value="law">Law</option>
                </select>
                <div class="error-message" id="reg-program-error">Please select a program</div>
            </div>
            
            <div class="form-group">
                <label for="reg-year">Year of Study</label>
                <select id="reg-year">
                    <option value="">Select Year</option>
                    <option value="1">Year 1</option>
                    <option value="2">Year 2</option>
                    <option value="3">Year 3</option>
                    <option value="4">Year 4</option>
                    <option value="5">Year 5</option>
                </select>
                <div class="error-message" id="reg-year-error">Please select your year of study</div>
            </div>

            <div class="form-group">
                <label for="reg-semester">Semester</label>
                <select id="reg-semester">
                    <option value="">Select Semester</option>
                    <option value="1">Semester 1</option>
                    <option value="2">Semester 2</option>
                </select>
                <div class="error-message" id="reg-semester-error">Please select a semester</div>
            </div>
            
            <div class="form-group">
                <label for="reg-password">Password</label>
                <input type="password" id="reg-password" placeholder="Create a password">
                <div class="error-message" id="reg-password-error">Password must be at least 8 characters</div>
            </div>
            
            <div class="form-group">
                <label for="reg-confirm">Confirm Password</label>
                <input type="password" id="reg-confirm" placeholder="Confirm your password">
                <div class="error-message" id="reg-confirm-error">Passwords do not match</div>
            </div>
            
            <div class="form-group">
                <button class="btn-primary" style="width: 100%; padding: 14px;" id="register-btn">Register</button>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <a href="#" id="show-login" style="color: var(--primary); text-decoration: none;">Back to Login</a>
            </div>
        </div>
    </div>
    <div class="container" id="app-container" style="display: none;">
        <header>
            <div class="app-title">
                <i class="fas fa-graduation-cap"></i>
                <div>
                    <h1>UniVerse (UV)</h1>
                    <p>Complete academic management system</p>
                </div>
            </div>
            <div class="user-info">
                <div class="user-details">
                    <div class="user-name" id="user-display">Dr. Sarah Johnson</div>
                    <div class="user-role" id="user-role">Lecturer - Computer Science</div>
                </div>
                <div class="user-avatar">SJ</div>
                <div class="notification-bell">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count">3</span>
                </div>
                <div class="private-bell" title="Private messages" style="margin-left:10px;cursor:pointer;">
                    <i class="fas fa-envelope"></i>
                    <span class="private-count" style="display:flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:var(--danger);color:white;font-size:0.7rem;margin-left:6px;">0</span>
                </div>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="dashboard"><i class="fas fa-home"></i> Dashboard</div>
            <div class="tab" data-tab="chat"><i class="fas fa-comments"></i> Chat</div>
            <div class="tab" data-tab="timetable"><i class="fas fa-calendar-alt"></i> Timetable</div>
            <div class="tab" data-tab="results"><i class="fas fa-chart-bar"></i> Results Portal</div>
            <div class="tab" data-tab="resources"><i class="fas fa-book"></i> Resources</div>
            <div class="tab" id="logout-tab"><i class="fas fa-sign-out-alt"></i> Logout</div>
        </div>

        <!-- Dashboard Section -->
        <div class="content-section active" id="dashboard-section">
            <h2 class="section-title">Dashboard</h2>
            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3><i class="fas fa-calendar-check"></i> Today's Classes</h3>
                    <div class="stat-item">
                        <span>Mathematics</span>
                        <span>09:00 - 10:00</span>
                    </div>
                    <div class="stat-item">
                        <span>Computer Science</span>
                        <span>10:00 - 11:00</span>
                    </div>
                    <div class="stat-item">
                        <span>Physics</span>
                        <span>11:00 - 12:00</span>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h3><i class="fas fa-tasks"></i> Pending Tasks</h3>
                    <div class="stat-item">
                        <span>Grade Assignments</span>
                        <span class="grade">12</span>
                    </div>
                    <div class="stat-item">
                        <span>Update Timetable</span>
                        <span class="grade">3</span>
                    </div>
                    <div class="stat-item">
                        <span>Student Meetings</span>
                        <span class="grade">5</span>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h3><i class="fas fa-bullhorn"></i> Announcements</h3>
                    <div class="stat-item">
                        <span>Midterm Exams</span>
                        <span>Next Week</span>
                    </div>
                    <div class="stat-item">
                        <span>Holiday Notice</span>
                        <span>Oct 25</span>
                    </div>
                    <div class="stat-item">
                        <span>Project Submission</span>
                        <span>Nov 5</span>
                    </div>
                </div>
            </div>
            
            <div class="calendar-view">
                <div class="calendar-day">
                    <div class="day-name">Mon</div>
                    <div class="day-number">16</div>
                </div>
                <div class="calendar-day">
                    <div class="day-name">Tue</div>
                    <div class="day-number">17</div>
                </div>
                <div class="calendar-day has-class">
                    <div class="day-name">Wed</div>
                    <div class="day-number">18</div>
                </div>
                <div class="calendar-day has-class">
                    <div class="day-name">Thu</div>
                    <div class="day-number">19</div>
                </div>
                <div class="calendar-day current">
                    <div class="day-name">Fri</div>
                    <div class="day-number">20</div>
                </div>
                <div class="calendar-day">
                    <div class="day-name">Sat</div>
                    <div class="day-number">21</div>
                </div>
                <div class="calendar-day">
                    <div class="day-name">Sun</div>
                    <div class="day-number">22</div>
                </div>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="content-section" id="chat-section">
            <h2 class="section-title">Class Chat</h2>
            
            <!-- Conversations / Classmates Column -->
            <div class="user-list">
                <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;">
                    <h3 style="margin:0;">Conversations</h3>
                    <button id="new-chat-btn" title="Start new chat" style="background:transparent;border:none;color:#0b76f6;cursor:pointer;font-weight:600">New</button>
                </div>
                <div id="conversations-list" style="max-height:220px;overflow:auto;padding:6px 12px;border-top:1px solid #eee;margin-bottom:8px;">
                    <!-- Recent conversations will be rendered here -->
                </div>
                <h3 style="margin-top:8px;">Classmates</h3>
                <h3>Classmates</h3>
                 <div class="user-item" data-user="sarah">
                    <div class="user-avatar">S</div>
                    <div class="user-info">
                        <div class="user-name">Sarah Johnson</div>
                        <div class="user-title">Computer Science</div>
                    </div>
                    <div class="user-status"></div>
                </div>
                <div class="user-item" data-user="mike">
                    <div class="user-avatar">M</div>
                    <div class="user-info">
                        <div class="user-name">Mike Chen</div>
                        <div class="user-title">Mathematics</div>
                    </div>
                    <div class="user-status"></div>
                </div>
                <div class="user-item" data-user="emma">
                    <div class="user-avatar">E</div>
                    <div class="user-info">
                        <div class="user-name">Emma Davis</div>
                        <div class="user-title">Physics</div>
                    </div>
                    <div class="user-status"></div>
                </div> 
            </div>
            
            <div class="chat-container">
                <div class="chat-header">
                    <h3>Computer Science Group</h3>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <div class="online-users">
                            <span>Online: </span>
                            <div class="user-count">24</div>
                        </div>
                        <div id="typing-indicator" style="font-size:0.9rem;color:#666"></div>
                        <a href="#" class="whatsapp-link" style="margin-left:8px;">
                            <i class="fab fa-whatsapp"></i> Join WhatsApp Group
                        </a>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <!-- Messages will be loaded here -->
                </div>
                <div class="chat-input">
                    <button id="emoji-btn" title="Emoji" style="background:transparent;border:none;cursor:pointer;margin-right:6px;font-size:18px">😊</button>
                    <input type="text" id="message-input" placeholder="Type your message here...">
                    <div class="chat-input-actions">
                        <label for="file-input" style="cursor: pointer;">
                            <i class="fas fa-paperclip"></i>
                        </label>
                        <input type="file" id="file-input" style="display: none;">
                        <button id="send-button"><i class="fas fa-paper-plane"></i></button>
                    </div>
                    <div id="emoji-menu" style="position:relative;display:none;">
                        <!-- richer grouped emoji picker -->
                        <div id="emoji-picker" style="position:absolute;background:white;border:1px solid #ddd;padding:8px;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,0.12);width:260px;">
                            <div id="emoji-cats" style="display:flex;gap:6px;margin-bottom:6px;overflow:auto;">
                                <!-- category buttons populated by JS -->
                            </div>
                            <div id="emoji-grid" style="display:grid;grid-template-columns:repeat(8,28px);gap:6px;max-height:160px;overflow:auto;padding:4px;border-top:1px solid #f1f3f6;">
                                <!-- emojis populated by JS -->
                            </div>
                            <div id="emoji-recent" style="margin-top:8px;font-size:0.85rem;color:#666;display:none;">
                                Recent:
                                <div id="emoji-recent-list" style="display:inline-block;margin-left:6px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timetable Section -->
        <div class="content-section" id="timetable-section">
            <h2 class="section-title">Class Timetable</h2>
            
            <div class="timetable-controls">
                <div>
                    <span id="week-display">Week of October 16, 2023</span>
                </div>
                <div class="timetable-actions">
                    <button class="btn-primary" id="prev-week"><i class="fas fa-chevron-left"></i> Previous</button>
                    <button class="btn-secondary" id="next-week">Next <i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            
            <!-- Program Selection -->
            <div class="form-group">
                <label for="program-select">Select Program</label>
                <select id="program-select">
                    <option value="cs">Computer Science</option>
                    <option value="eng">Engineering</option>
                    <option value="bus">Business Administration</option>
                    <option value="med">Medicine</option>
                    <option value="law">Law</option>
                </select>
            </div>
            
            <div class="control-grid">
                <div class="form-group">
                    <label for="year-select">Year of Study</label>
                    <select id="year-select">
                        <option value="1">Year 1</option>
                        <option value="2">Year 2</option>
                        <option value="3">Year 3</option>
                        <option value="4">Year 4</option>
                        <option value="5">Year 5</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="semester-select">Semester</label>
                    <select id="semester-select">
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                    </select>
                </div>
            </div>
            
            <!-- Lecturer Controls -->
            <div class="lecturer-controls" id="lecturer-controls">
                <h3><i class="fas fa-cogs"></i> Lecturer Controls</h3>
                <div class="control-grid">
                    <div class="form-group">
                        <label for="class-select">Select Class</label>
                        <select id="class-select">
                            <option value="math">Mathematics - Room 302</option>
                            <option value="cs">Computer Science - Lab 105</option>
                            <option value="physics">Physics - Room 204</option>
                            <option value="literature">Literature - Room 101</option>
                            <option value="programming">Programming Lab - Lab 203</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="class-date">Date</label>
                        <input type="date" id="class-date" value="2023-10-20">
                    </div>
                    <div class="form-group">
                        <label for="class-time">Time</label>
                        <input type="time" id="class-time" value="09:00">
                    </div>
                    <div class="form-group">
                        <label for="class-status">Status</label>
                        <select id="class-status">
                            <option value="available">Available</option>
                            <option value="unavailable">Unavailable</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="makeup">Make-up Class</option>
                        </select>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="update-timetable"><i class="fas fa-sync-alt"></i> Update Status</button>
                    <button class="btn-secondary" id="take-attendance"><i class="fas fa-clipboard-check"></i> Take Attendance</button>
                </div>
            </div>
            
            <table class="timetable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Monday</th>
                        <th>Tuesday</th>
                        <th>Wednesday</th>
                        <th>Thursday</th>
                        <th>Friday</th>
                    </tr>
                </thead>
                <tbody id="timetable-body">
                    <!-- Timetable will be generated here -->
                </tbody>
            </table>
            
            <div class="status-legend" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                <h4>Status Legend:</h4>
                <div style="display: flex; gap: 15px; margin-top: 10px;">
                    <div><span class="status-indicator status-available"></span> Available</div>
                    <div><span class="status-indicator status-unavailable"></span> Unavailable</div>
                    <div><span class="status-indicator status-cancelled"></span> Cancelled</div>
                    <div><span class="status-indicator" style="background-color: #f39c12;"></span> Make-up Class</div>
                </div>
            </div>
        </div>

        <!-- Results Portal Section -->
        <div class="content-section" id="results-section">
            <div class="results-header">
                <h2 class="section-title">Academic Results</h2>
                <select class="semester-select" id="results-semester-select">
                    <option>Fall 2023</option>
                    <option>Spring 2023</option>
                    <option>Fall 2022</option>
                </select>
            </div>
            
            <!-- Grade Management (Lecturer Only) -->
            <div class="lecturer-controls" id="grade-management">
                <h3><i class="fas fa-tasks"></i> Grade Management</h3>
                <div class="control-grid">
                    <div class="form-group">
                        <label for="course-select">Select Course</label>
                        <select id="course-select">
                            <option>Computer Science 101</option>
                            <option>Mathematics 202</option>
                            <option>Physics 105</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="assignment-select">Select Assignment</label>
                        <select id="assignment-select">
                            <option>Midterm Exam</option>
                            <option>Final Project</option>
                            <option>Quiz 1</option>
                            <option>Quiz 2</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="student-select">Select Student</label>
                        <select id="student-select">
                            <option>John Doe (S12345)</option>
                            <option>Jane Smith (S12346)</option>
                            <option>Robert Johnson (S12347)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="grade-input">Grade</label>
                        <input type="text" id="grade-input" placeholder="Enter grade">
                    </div>
                    <div class="form-group">
                        <label for="due-date-input">Due Date</label>
                        <input type="date" id="due-date-input">
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="save-grade"><i class="fas fa-save"></i> Save Grade</button>
                    <button class="btn-secondary" id="export-grades"><i class="fas fa-download"></i> Export Grades</button>
                </div>
            </div>
            
            <table class="results-table" id="results-table">
                <thead>
                    <tr>
                        <th>Course Code</th>
                        <th>Course Name</th>
                        <th>Credits</th>
                        <th>Grade</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Results will be loaded here -->
                </tbody>
            </table>
            
            <div class="stats-box">
                <h3>Semester Summary</h3>
                <div class="stat-item">
                    <span>Total Credits:</span>
                    <span id="total-credits">0</span>
                </div>
                <div class="stat-item">
                    <span>GPA:</span>
                    <span id="gpa">0.00</span>
                </div>
                <div class="stat-item">
                    <span>Status:</span>
                    <span id="academic-status">-</span>
                </div>
            </div>
            
            <!-- Admin Section (only visible to admin) -->
            <div class="admin-section" id="admin-section">
                <h2><i class="fas fa-lock"></i> Admin: Class Teaching Records</h2>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Lecturer</th>
                            <th>Course</th>
                            <th>Date</th>
                            <th>Duration</th>
                            <th>Attendance</th>
                        </tr>
                    </thead>
                    <tbody id="teaching-records">
                        <!-- Teaching records will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Resources Section -->
        <div class="content-section" id="resources-section">
            <h2 class="section-title">Learning Resources</h2>
            
            <!-- Lecturer Resource Management -->
            <div class="lecturer-controls" id="resource-management">
                <h3><i class="fas fa-plus-circle"></i> Add Resources</h3>
                <div class="control-grid">
                    <div class="form-group">
                        <label for="resource-course">Course</label>
                        <select id="resource-course">
                            <option>Computer Science 101</option>
                            <option>Mathematics 202</option>
                            <option>Physics 105</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="resource-title">Resource Title</label>
                        <input type="text" id="resource-title" placeholder="Enter resource title">
                    </div>
                    <div class="form-group">
                        <label for="resource-type">Resource Type</label>
                        <select id="resource-type">
                            <option>Lecture Notes</option>
                            <option>Assignment</option>
                            <option>Reading Material</option>
                            <option>Video Lecture</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="resource-file">Upload File</label>
                        <input type="file" id="resource-file">
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="add-resource"><i class="fas fa-plus"></i> Add Resource</button>
                </div>
            </div>
            
            <div class="resources-grid" id="resources-grid">
                <!-- Resources will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div class="modal" id="attendance-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Take Attendance</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="form-group">
                <label for="attendance-class">Class</label>
                <select id="attendance-class">
                    <option value="math">Mathematics</option>
                    <option value="cs">Computer Science</option>
                    <option value="physics">Physics</option>
                </select>
            </div>
            <div class="form-group">
                <label for="attendance-date">Date</label>
                <input type="date" id="attendance-date">
            </div>
            <h3>Students</h3>
            <div class="attendance-list" id="attendance-list" style="max-height: 300px; overflow-y: auto;">
                <!-- Attendance list will be generated here -->
            </div>
            <button class="btn btn-primary" style="margin-top: 20px; width: 100%;" id="submit-attendance">Submit Attendance</button>
        </div>
    </div>

    <!-- Private Chat Modal -->
    <div class="modal" id="private-chat-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div style="display:flex;align-items:center;gap:12px;">
                    <div id="private-recipient-avatar" style="width:40px;height:40px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:700">U</div>
                    <div>
                        <h2 class="modal-title" id="private-chat-title">Private Chat</h2>
                        <div id="private-recipient-meta" style="font-size:0.85rem;color:#666">Last seen: <span id="private-last-seen">unknown</span> • <span id="private-typing-indicator" style="font-style:italic"></span></div>
                    </div>
                </div>
                <span class="close-modal">&times;</span>
            </div>
            <div class="chat-messages" id="private-chat-messages" style="height: 300px;">
                <!-- Private messages will be loaded here -->
            </div>
            <div class="chat-input">
                <button id="private-emoji-btn" title="Emoji" style="background:transparent;border:none;cursor:pointer;margin-right:6px;font-size:18px">😊</button>
                <input type="text" id="private-message-input" placeholder="Type your private message here...">
                <div class="chat-input-actions">
                    <button id="send-private-button"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div class="modal" id="notifications-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Notifications</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div id="notifications-list" style="max-height: 60vh; overflow-y: auto;">
                <!-- Notifications will be rendered here -->
            </div>
            <div style="margin-top:15px; text-align:right;">
                <button class="btn-secondary" id="mark-all-read">Mark all as read</button>
            </div>
        </div>
    </div>

    <script>
                // Firebase config for UniVerse (UV)
                const firebaseConfig = {
                    apiKey: "AIzaSyDibqVZXj0_6-hbyW80YtewjkJAIV4xejY",
                    authDomain: "university-app-c5c51.firebaseapp.com",
                    databaseURL: "https://university-app-c5c51-default-rtdb.firebaseio.com",
                    projectId: "university-app-c5c51",
                    storageBucket: "university-app-c5c51.firebasestorage.app",
                    messagingSenderId: "337747280552",
                    appId: "1:337747280552:web:460b49e59b82a15d86b89d"
                };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();
        // Now you can use auth, db, and rtdb for real-time features
        // Application State
        const state = {
            currentUser: null,
            currentRole: 'student',
            timetable: [],
            chatMessages: [],
            privateChats: {},
            courses: [],
            students: [],
            attendanceRecords: [],
            teachingRecords: [],
            resources: [],
            programs: [], // Will be loaded from Firebase
            tasks: [], // Will be loaded from Firebase
            currentPrivateChatId: null
        };

        // Initialize the application
        function initApp() {
            // Load programs from Firebase
            rtdb.ref('programs').on('value', (snapshot) => {
                state.programs = Object.values(snapshot.val() || {});
                populateProgramSelect();
            });
            // Load courses in real-time
            rtdb.ref('courses').on('value', (snapshot) => {
                const obj = snapshot.val() || {};
                // convert keyed object to array
                state.courses = Object.keys(obj).map(k => Object.assign({ id: k }, obj[k]));
                populateCourseSelect();
                // If admin manage modal exists, re-render its list
                if (typeof renderCoursesList === 'function') renderCoursesList();
            });
            // Check if user is logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                state.currentUser = JSON.parse(savedUser);
                state.currentRole = state.currentUser.role;
                showApp();
            } else {
                showLogin();
            }
            // Set up event listeners
            setupEventListeners();
            // Load initial data
            loadInitialData();
        }

        // Show login screen
        function showLogin() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('registration-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'none';
        }

        // Show registration screen
        function showRegistration() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('registration-container').style.display = 'block';
            document.getElementById('app-container').style.display = 'none';
        }

        // Show application
        function showApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            // Real-time online user tracking
            setUserOnlineStatus();
            loadOnlineUsers();
            // Update UI based on user role
            updateUIForRole();
            // Load user-specific data
            loadUserData();
        }


       // Set up event listeners
        function setupEventListeners() {
            // Login functionality
            document.querySelectorAll('.login-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.login-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    state.currentRole = this.getAttribute('data-role');
                });
            });

            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('show-register').addEventListener('click', function(e) {
                e.preventDefault();
                showRegistration();
            });
            document.getElementById('show-login').addEventListener('click', function(e) {
                e.preventDefault();
                showLogin();
            });
            document.getElementById('register-btn').addEventListener('click', handleRegistration);

            // Add input validation for registration form
            document.getElementById('reg-fullname').addEventListener('blur', validateFullName);
            document.getElementById('reg-id').addEventListener('blur', validateId);
            document.getElementById('reg-email').addEventListener('blur', validateEmail);
            document.getElementById('reg-program').addEventListener('change', validateProgram);
            document.getElementById('reg-year').addEventListener('change', validateYear);
            document.getElementById('reg-password').addEventListener('blur', validatePassword);
            document.getElementById('reg-confirm').addEventListener('blur', validateConfirmPassword);

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    if (this.id === 'logout-tab') {
                        handleLogout();
                        return;
                    }
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    const tabName = this.getAttribute('data-tab');
                    document.getElementById(`${tabName}-section`).classList.add('active');
                    
                    // Load data for the selected tab
                    if (tabName === 'timetable') updateTimetable();
                    if (tabName === 'resources') loadResources();
                });
            });

            // Chat functionality
            document.getElementById('send-button').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // Emoji picker and typing indicator initialization
            initEmojiPicker();
            subscribeTypingIndicators();

            // Private chat functionality
            document.querySelectorAll('.user-item').forEach(item => {
                item.addEventListener('click', function() {
                    const token = this.getAttribute('data-user');
                    if (!token) return;
                    // Try to resolve token to an id. token may be an id or a short name like 'sarah'
                    let target = null;
                    // First try exact id match
                    target = (state.students || []).find(s => String(s.id) === String(token)) || (state.lecturers || []).find(l => String(l.id) === String(token));
                    if (!target) {
                        // Try name match (case-insensitive contains)
                        const t = token.toString().toLowerCase();
                        target = (state.students || []).find(s => (s.name || '').toLowerCase().includes(t)) || (state.lecturers || []).find(l => (l.name || '').toLowerCase().includes(t));
                    }
                    if (target && target.id) {
                        openPrivateChat(target.id);
                        return;
                    }

                    // If not found in state, do a one-time DB lookup (covers case where state isn't loaded yet)
                    console.log('Private chat: user not found in state, querying DB for token=', token);
                    rtdb.ref('users').once('value').then(snap => {
                        const users = Object.values(snap.val() || {});
                        const t = token.toString().toLowerCase();
                        const found = users.find(u => (String(u.id) === String(token)) || ((u.name||'').toLowerCase().includes(t)));
                        if (found && found.id) {
                            // update local caches
                            if (!state.students) state.students = [];
                            if (!state.lecturers) state.lecturers = [];
                            if (found.role === 'student' && !state.students.find(s => s.id === found.id)) state.students.push(found);
                            if (found.role === 'lecturer' && !state.lecturers.find(l => l.id === found.id)) state.lecturers.push(found);
                            openPrivateChat(found.id);
                        } else {
                            console.warn('Private chat: could not resolve user token', token);
                            alert('Could not find user: ' + token + '. Try searching the user list first.');
                        }
                    }).catch(err => {
                        console.error('Private chat DB lookup failed', err);
                        alert('Error resolving user for private chat. See console for details.');
                    });
                });
            });

            document.getElementById('send-private-button').addEventListener('click', sendPrivateMessage);
            document.getElementById('private-message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendPrivateMessage();
            });

            // typing events for private input
            const pinput = document.getElementById('private-message-input');
            if (pinput) {
                let ptypingTimer = null;
                pinput.addEventListener('input', () => {
                    setTyping(true, 'private:' + (document.getElementById('private-chat-modal')?.getAttribute('data-recipient') || ''));
                    clearTimeout(ptypingTimer);
                    ptypingTimer = setTimeout(() => setTyping(false, 'private:' + (document.getElementById('private-chat-modal')?.getAttribute('data-recipient') || '')), 1500);
                });
            }
            const pemoji = document.getElementById('private-emoji-btn');
            if (pemoji) pemoji.addEventListener('click', (e) => {
                e.stopPropagation();
                const menu = document.getElementById('emoji-menu'); if (!menu) return; menu.style.display = (menu.style.display==='block'?'none':'block');
            });

            // Timetable functionality
            document.getElementById('prev-week').addEventListener('click', () => {
                state.currentWeekOffset--;
                updateTimetable();
            });
            
            document.getElementById('next-week').addEventListener('click', () => {
                state.currentWeekOffset++;
                updateTimetable();
            });

            // Program selection
            document.getElementById('program-select').addEventListener('change', function() {
                updateTimetable();
                populateCourseSelect();
                updateChatHeader();
            });
            document.getElementById('year-select').addEventListener('change', updateTimetable);
            document.getElementById('semester-select').addEventListener('change', updateTimetable);

            // Lecturer functionality
            document.getElementById('update-timetable').addEventListener('click', updateTimetableStatus);
            document.getElementById('take-attendance').addEventListener('click', showAttendanceModal);
            document.getElementById('submit-attendance').addEventListener('click', submitAttendance);

            // Grade management
            document.getElementById('save-grade').addEventListener('click', saveGrade);
            document.getElementById('export-grades').addEventListener('click', exportGrades);

            // Resource management
            document.getElementById('add-resource').addEventListener('click', addResource);

            // Modal functionality
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                }
            });
        }

        // Handle login
        function handleLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            if (!username || !password) {
                alert('Please enter both ID and password');
                return;
            }
            // Check localStorage first
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            let user = users.find(u => u.id === username && u.password === password);
            if (user) {
                state.currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
                showApp();
                return;
            }
            // If not found, check Firebase
            rtdb.ref('users/' + username).once('value', (snapshot) => {
                const fbUser = snapshot.val();
                if (fbUser && fbUser.password === password) {
                    state.currentUser = fbUser;
                    localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
                    showApp();
                } else {
                    alert('Invalid credentials. Please try again.');
                }
            });
        }

        // Handle registration
        function handleRegistration() {
            // Validate all fields
            const isFullNameValid = validateFullName();
            const isIdValid = validateId();
            const isEmailValid = validateEmail();
            const isProgramValid = validateProgram();
            const isYearValid = validateYear();
            const isPasswordValid = validatePassword();
            const isConfirmValid = validateConfirmPassword();
            
            if (!isFullNameValid || !isIdValid || !isEmailValid || 
                !isProgramValid || !isYearValid || !isPasswordValid || !isConfirmValid) {
                alert('Please fix the errors in the form before submitting.');
                return;
            }
            
            const fullname = document.getElementById('reg-fullname').value;
            const id = document.getElementById('reg-id').value;
            const email = document.getElementById('reg-email').value;
            const program = document.getElementById('reg-program').value;
            const year = document.getElementById('reg-year').value;
            const semester = document.getElementById('reg-semester').value;
            const password = document.getElementById('reg-password').value;
            
            // Create new user
            const newUser = {
                id: id,
                name: fullname,
                email: email,
                role: state.currentRole,
                program: program,
                year: year,
                semester: semester,
                password: password
            };
            
            // Save user to localStorage
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            // Check if user already exists
            if (users.some(u => u.id === id)) {
                alert('This ID number is already registered. Please use a different ID or login.');
                return;
            }
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            // Save user to Firebase Realtime Database
            rtdb.ref('users/' + id).set(newUser);
            alert('Registration successful! You can now login.');
            // Clear form and go back to login
            document.getElementById('reg-fullname').value = '';
            document.getElementById('reg-id').value = '';
            document.getElementById('reg-email').value = '';
            document.getElementById('reg-program').selectedIndex = 0;
            document.getElementById('reg-year').selectedIndex = 0;
            document.getElementById('reg-semester').selectedIndex = 0;
            document.getElementById('reg-password').value = '';
            document.getElementById('reg-confirm').value = '';
            showLogin();
        }

        // Validation functions
        function validateFullName() {
            const fullname = document.getElementById('reg-fullname').value;
            const errorElement = document.getElementById('reg-fullname-error');
            const formGroup = document.getElementById('reg-fullname').parentElement;
            
            if (!fullname.trim()) {
                errorElement.textContent = 'Please enter your full name';
                formGroup.classList.add('error');
                return false;
            }
            
            formGroup.classList.remove('error');
            return true;
        }
        
        function validateId() {
            const id = document.getElementById('reg-id').value;
            const errorElement = document.getElementById('reg-id-error');
            const formGroup = document.getElementById('reg-id').parentElement;
            
            if (!id.trim()) {
                errorElement.textContent = 'Please enter your ID number';
                formGroup.classList.add('error');
                return false;
            }
            
            // Check if ID format is valid (at least 5 characters)
            if (id.length < 5) {
                errorElement.textContent = 'ID number must be at least 5 characters';
                formGroup.classList.add('error');
                return false;
            }
            
            formGroup.classList.remove('error');
            return true;
        }
        
        function validateEmail() {
            const email = document.getElementById('reg-email').value;
            const errorElement = document.getElementById('reg-email-error');
            const formGroup = document.getElementById('reg-email').parentElement;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!email.trim()) {
                errorElement.textContent = 'Please enter your email address';
                formGroup.classList.add('error');
                return false;
            }
            
            if (!emailRegex.test(email)) {
                errorElement.textContent = 'Please enter a valid email address';
                formGroup.classList.add('error');
                return false;
            }
            
            formGroup.classList.remove('error');
            return true;
        }
        
        function validateProgram() {
            const program = document.getElementById('reg-program').value;
            const errorElement = document.getElementById('reg-program-error');
            const formGroup = document.getElementById('reg-program').parentElement;
            
            if (!program) {
                errorElement.textContent = 'Please select a program';
                formGroup.classList.add('error');
                return false;
            }
            
            formGroup.classList.remove('error');
            return true;
        }
        
        function validateYear() {
            const year = document.getElementById('reg-year').value;
            const errorElement = document.getElementById('reg-year-error');
            const formGroup = document.getElementById('reg-year').parentElement;
            
            if (!year) {
                errorElement.textContent = 'Please select your year of study';
                formGroup.classList.add('error');
                return false;
            }
            
            formGroup.classList.remove('error');
            return true;
        }
        
        function validatePassword() {
            const password = document.getElementById('reg-password').value;
            const errorElement = document.getElementById('reg-password-error');
            const formGroup = document.getElementById('reg-password').parentElement;
            
            if (!password) {
                errorElement.textContent = 'Please enter a password';
                formGroup.classList.add('error');
                return false;
            }
            
            if (password.length < 8) {
                errorElement.textContent = 'Password must be at least 8 characters';
                formGroup.classList.add('error');
                return false;
            }
            
            formGroup.classList.remove('error');
            return true;
        }
        
        function validateConfirmPassword() {
            const password = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm').value;
            const errorElement = document.getElementById('reg-confirm-error');
            const formGroup = document.getElementById('reg-confirm').parentElement;
            
            if (!confirm) {
                errorElement.textContent = 'Please confirm your password';
                formGroup.classList.add('error');
                return false;
            }
            
            if (password !== confirm) {
                errorElement.textContent = 'Passwords do not match';
                formGroup.classList.add('error');
                return false;
            }
            
            formGroup.classList.remove('error');
            return true;
        }

        // Handle logout
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                state.currentUser = null;
                // Always show login page and hide app
                document.getElementById('login-container').style.display = 'block';
                document.getElementById('app-container').style.display = 'none';
                showLogin();
            }
        }

        // Update UI based on user role
        function updateUIForRole() {
            if (!state.currentUser) return;
            
            document.getElementById('user-display').textContent = state.currentUser.name;
            document.getElementById('user-role').textContent = `${state.currentUser.role.charAt(0).toUpperCase() + state.currentUser.role.slice(1)} - ${state.currentUser.program || 'Administration'}`;
            
            // Show/hide role-specific elements
            const isLecturer = state.currentUser.role === 'lecturer';
            const isAdmin = state.currentUser.role === 'admin';
            const isStudent = state.currentUser.role === 'student';
            
            document.getElementById('lecturer-controls').style.display = isLecturer ? 'block' : 'none';
            document.getElementById('grade-management').style.display = isLecturer ? 'block' : 'none';
            document.getElementById('resource-management').style.display = isLecturer ? 'block' : 'none';
            document.getElementById('admin-section').style.display = isAdmin ? 'block' : 'none';
            
                // Ensure admin has a Manage Courses & Classes button in timetable controls
                const timetableTools = document.querySelector('.timetable-actions');
                if (isAdmin && timetableTools) {
                    if (!document.getElementById('manage-courses-classes-btn')) {
                        const btn = document.createElement('button');
                        btn.id = 'manage-courses-classes-btn';
                        btn.className = 'btn-secondary';
                        btn.textContent = 'Manage Courses & Classes';
                        btn.style.marginLeft = '10px';
                        btn.onclick = showManageCoursesClassesModal;
                        timetableTools.appendChild(btn);
                    }
                } else {
                    const existingBtn = document.getElementById('manage-courses-classes-btn');
                    if (existingBtn) existingBtn.remove();
                }

                // Also add a button inside the admin section area for quick access
                const adminSection = document.getElementById('admin-section');
                if (adminSection) {
                    let adminBtn = document.getElementById('manage-courses-admin-btn');
                    if (isAdmin) {
                        if (!adminBtn) {
                            adminBtn = document.createElement('button');
                            adminBtn.id = 'manage-courses-admin-btn';
                            adminBtn.className = 'btn-secondary';
                            adminBtn.style.marginTop = '10px';
                            adminBtn.textContent = 'Manage Courses & Classes';
                            adminBtn.onclick = showManageCoursesClassesModal;
                            adminSection.insertBefore(adminBtn, adminSection.firstChild);
                        }
                    } else if (adminBtn) {
                        adminBtn.remove();
                    }
                }

                // Ensure admin has a Manage Timetable button in timetable controls
                if (isAdmin && timetableTools) {
                    if (!document.getElementById('manage-timetable-btn')) {
                        const tbtn = document.createElement('button');
                        tbtn.id = 'manage-timetable-btn';
                        tbtn.className = 'btn-secondary';
                        tbtn.textContent = 'Manage Timetable';
                        tbtn.style.marginLeft = '10px';
                        tbtn.onclick = showManageTimetableModal;
                        timetableTools.appendChild(tbtn);
                    }
                } else {
                    const existingTBtn = document.getElementById('manage-timetable-btn');
                    if (existingTBtn) existingTBtn.remove();
                }

                // Also add a Manage Timetable button inside the admin section
                if (adminSection) {
                    let adminTBtn = document.getElementById('manage-timetable-admin-btn');
                    if (isAdmin) {
                        if (!adminTBtn) {
                            adminTBtn = document.createElement('button');
                            adminTBtn.id = 'manage-timetable-admin-btn';
                            adminTBtn.className = 'btn-secondary';
                            adminTBtn.style.marginTop = '10px';
                            adminTBtn.textContent = 'Manage Timetable';
                            adminTBtn.onclick = showManageTimetableModal;
                            adminSection.insertBefore(adminTBtn, adminSection.firstChild);
                        }
                    } else if (adminTBtn) {
                        adminTBtn.remove();
                    }
                }

            // Update dashboard based on role
            // Prefill timetable controls for students/lecturers
            try {
                const programSelect = document.getElementById('program-select');
                // ensure program options reflect live state
                try { populateProgramSelect(); } catch (e) {}
                const yearSelect = document.getElementById('year-select');
                const semesterSelect = document.getElementById('semester-select');
                const user = state.currentUser || {};
                if (user.role === 'student' || user.role === 'lecturer') {
                    if (programSelect && user.program) {
                        // resolve program id from name or id
                        const pid = resolveProgramId(user.program);
                        // ensure the option exists, otherwise add it with friendly label
                        let exists = Array.from(programSelect.options).some(o => o.value === pid);
                        if (!exists) {
                            // find program name if present
                            const found = (state.programs || []).find(p => p.id === pid) || (state.programs || []).find(p => p.name === user.program);
                            const opt = document.createElement('option'); opt.value = pid; opt.textContent = found ? found.name : user.program; programSelect.appendChild(opt);
                        }
                        programSelect.value = pid;
                    }
                    if (yearSelect && user.year) {
                        yearSelect.value = user.year;
                    }
                    if (semesterSelect && user.semester) {
                        semesterSelect.value = user.semester;
                    }
                    // Students see a locked view by default; lecturers can change
                    if (user.role === 'student') {
                        if (programSelect) programSelect.disabled = true;
                        if (yearSelect) yearSelect.disabled = true;
                        if (semesterSelect) semesterSelect.disabled = true;
                    } else {
                        if (programSelect) programSelect.disabled = false;
                        if (yearSelect) yearSelect.disabled = false;
                        if (semesterSelect) semesterSelect.disabled = false;
                    }
                    // Refresh timetable for the user's defaults
                    updateTimetable();
                } else {
                    // non-student users get full control
                    if (programSelect) programSelect.disabled = false;
                    if (yearSelect) yearSelect.disabled = false;
                    if (semesterSelect) semesterSelect.disabled = false;
                }
            } catch (e) { console.error('prefill timetable controls error', e); }

            updateDashboard();
        }

        // Update dashboard based on user role
        function updateDashboard() {
            const dashboardGrid = document.querySelector('.dashboard-grid');
            
            if (state.currentUser.role === 'student') {
                dashboardGrid.innerHTML = `
                    <div class="dashboard-card">
                        <h3><i class="fas fa-calendar-check"></i> Today's Classes</h3>
                        <div class="stat-item">
                            <span>Mathematics</span>
                            <span>09:00 - 10:00</span>
                        </div>
                        <div class="stat-item">
                            <span>Computer Science</span>
                            <span>10:00 - 11:00</span>
                        </div>
                        <div class="stat-item">
                            <span>Physics</span>
                            <span>11:00 - 12:00</span>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-tasks"></i> Upcoming Assignments</h3>
                        <div class="stat-item">
                            <span>Math Homework</span>
                            <span>Due Tomorrow</span>
                        </div>
                        <div class="stat-item">
                            <span>CS Project</span>
                            <span>Due Next Week</span>
                        </div>
                        <div class="stat-item">
                            <span>Physics Lab</span>
                            <span>Due Friday</span>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-bullhorn"></i> Announcements</h3>
                        <div class="stat-item">
                            <span>Midterm Exams</span>
                            <span>Next Week</span>
                        </div>
                        <div class="stat-item">
                            <span>Holiday Notice</span>
                            <span>Oct 25</span>
                        </div>
                        <div class="stat-item">
                            <span>Project Submission</span>
                            <span>Nov 5</span>
                        </div>
                    </div>
                `;
            } else if (state.currentUser.role === 'lecturer') {
                dashboardGrid.innerHTML = `
                    <div class="dashboard-card">
                        <h3><i class="fas fa-chalkboard-teacher"></i> Today's Classes</h3>
                        <div class="stat-item">
                            <span>Mathematics</span>
                            <span>09:00 - 10:00</span>
                        </div>
                        <div class="stat-item">
                            <span>Computer Science</span>
                            <span>10:00 - 11:00</span>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <h3><i class="fas fa-tasks"></i> Teaching Tasks</h3>
                        <button id="create-assignment-btn" style="margin-bottom:10px;">+ Create Assignment</button>
                        <div class="stat-item">
                            <span>Grade Assignments</span>
                            <span class="grade">12</span>
                        </div>
                        <div class="stat-item">
                            <span>Update Timetable</span>
                            <span class="grade">3</span>
                        </div>
                        <div class="stat-item">
                            <span>Student Meetings</span>
                            <span class="grade">5</span>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <h3><i class="fas fa-bullhorn"></i> Announcements</h3>
                        <div class="stat-item">
                            <span>Department Meeting</span>
                            <span>Tomorrow</span>
                        </div>
                        <div class="stat-item">
                            <span>Exam Schedule</span>
                            <span>Posted</span>
                        </div>
                        <div class="stat-item">
                            <span>Curriculum Review</span>
                            <span>Next Month</span>
                        </div>
                    </div>
                `;
                // Add event listener for create assignment button
                setTimeout(() => {
                    const btn = document.getElementById('create-assignment-btn');
                    if (btn) btn.onclick = showCreateAssignmentModal;
                }, 100);
        // Show modal for lecturers to create assignment
        function showCreateAssignmentModal() {
            let modal = document.getElementById('create-assignment-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'create-assignment-modal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width:420px;">
                        <span class="close-modal" style="float:right;cursor:pointer;font-size:20px;">&times;</span>
                        <h3>Create Assignment</h3>
                        <div style="margin-bottom:10px;">
                            <label>Title:</label><br>
                            <input type="text" id="assignment-title-input" style="width:100%;margin-bottom:8px;" />
                            <label>Description:</label><br>
                            <textarea id="assignment-desc-input" style="width:100%;margin-bottom:8px;"></textarea>
                            <label>Course:</label><br>
                            <select id="assignment-course-input" style="width:100%;margin-bottom:8px;"></select>
                            <label>Due Date:</label><br>
                            <input type="date" id="assignment-due-input" style="width:100%;margin-bottom:8px;" />
                            <label>Attach File (optional):</label><br>
                            <input type="file" id="assignment-file-upload" style="margin-bottom:8px;" />
                        </div>
                        <button id="submit-create-assignment-btn">Create</button>
                    </div>
                `;
                document.body.appendChild(modal);
                // Close modal event
                modal.querySelector('.close-modal').onclick = () => { modal.style.display = 'none'; };
                window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
            }
            // Populate course dropdown
            const courseSelect = document.getElementById('assignment-course-input');
            courseSelect.innerHTML = '';
            (state.courses || []).forEach(course => {
                const opt = document.createElement('option');
                opt.value = course.name || course.code || course.id;
                opt.textContent = course.name || course.code || course.id;
                courseSelect.appendChild(opt);
            });
            modal.style.display = 'flex';
            document.getElementById('submit-create-assignment-btn').onclick = function() {
                const title = document.getElementById('assignment-title-input').value.trim();
                const desc = document.getElementById('assignment-desc-input').value.trim();
                const course = document.getElementById('assignment-course-input').value;
                const dueDate = document.getElementById('assignment-due-input').value;
                const fileInput = document.getElementById('assignment-file-upload');
                if (!title || !course || !dueDate) {
                    alert('Please fill in title, course, and due date.');
                    return;
                }
                // Handle file upload if file selected
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const storageRef = firebase.storage().ref(`assignment_files/${course}/${Date.now()}_${file.name}`);
                    const uploadTask = storageRef.put(file);
                    uploadTask.on('state_changed', null, function(error) {
                        alert('File upload failed: ' + error.message);
                    }, function() {
                        uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                            saveAssignmentToFirebase(title, desc, course, dueDate, downloadURL, file.name);
                            modal.style.display = 'none';
                        });
                    });
                } else {
                    saveAssignmentToFirebase(title, desc, course, dueDate, '', '');
                    modal.style.display = 'none';
                }
            };
        }

        // Save assignment to Firebase
        function saveAssignmentToFirebase(title, desc, course, dueDate, fileUrl, fileName) {
            const assignment = {
                title: title,
                description: desc,
                course: course,
                dueDate: dueDate,
                fileUrl: fileUrl,
                fileName: fileName,
                createdBy: state.currentUser ? state.currentUser.name : '',
                createdAt: Date.now(),
                role: 'student'
            };
            rtdb.ref('tasks').push(assignment);
            // Notify students about new assignment
            sendNotification({
                title: 'New Assignment',
                message: `${assignment.title} for ${assignment.course} is due ${assignment.dueDate}`
            });
            // Optionally show a brief UI confirmation
            const toast = document.createElement('div');
            toast.textContent = 'Assignment created and students notified';
            toast.style.position = 'fixed';
            toast.style.right = '20px';
            toast.style.bottom = '20px';
            toast.style.background = 'rgba(0,0,0,0.8)';
            toast.style.color = 'white';
            toast.style.padding = '10px 14px';
            toast.style.borderRadius = '6px';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }
            } else if (state.currentUser.role === 'admin') {
                // Real-time system overview
                function renderSystemOverview(students, lecturers, courses) {
                    dashboardGrid.innerHTML = `
                        <div class="dashboard-card">
                            <h3><i class="fas fa-users"></i> System Overview</h3>
                            <div class="stat-item">
                                <span>Total Students</span>
                                <span>${students.length}</span>
                            </div>
                            <div class="stat-item">
                                <span>Total Lecturers</span>
                                <span>${lecturers.length}</span>
                            </div>
                            <div class="stat-item">
                                <span>Active Courses</span>
                                <span>${courses.length}</span>
                            </div>
                        </div>
                        <div class="dashboard-card">
                            <h3><i class="fas fa-tasks"></i> Administrative Tasks</h3>
                            <button id="manage-programs-btn" style="margin-bottom:10px;">Manage Programs</button>
                            <div class="stat-item">
                                <span>Pending Approvals</span>
                                <span class="grade">7</span>
                            </div>
                            <div class="stat-item">
                                <span>System Updates</span>
                                <span class="grade">2</span>
                            </div>
                            <div class="stat-item">
                                <span>Reports to Generate</span>
                                <span class="grade">5</span>
                            </div>
                        </div>
                        <div class="dashboard-card">
                            <h3><i class="fas fa-bullhorn"></i> Announcements</h3>
                            <div class="stat-item">
                                <span>System Maintenance</span>
                                <span>This Weekend</span>
                            </div>
                            <div class="stat-item">
                                <span>New Features</span>
                                <span>Deployed</span>
                            </div>
                            <div class="stat-item">
                                <span>Staff Meeting</span>
                                <span>Friday</span>
                            </div>
                        </div>
                    `;
                    setTimeout(() => {
                        const btn = document.getElementById('manage-programs-btn');
                        if (btn) btn.onclick = showManageProgramsModal;
                    }, 100);
                }
                // Listen for real-time changes
                rtdb.ref('users').on('value', (snapshot) => {
                    const raw = snapshot.val();
                    console.log('RTDB: users snapshot received', raw);
                    const users = Object.values(raw || {});
                    // store raw users map for debugging
                    state.users = raw || {};
                    const students = users.filter(u => u.role === 'student');
                    const lecturers = users.filter(u => u.role === 'lecturer');
                    // Get courses real-time
                    rtdb.ref('courses').on('value', (snap) => {
                        const courses = Object.values(snap.val() || {});
                        renderSystemOverview(students, lecturers, courses);
                        // Render classmates list (real users)
                        if (typeof renderClassmates === 'function') renderClassmates(users);
                    });
                });
        // Debug helper: call from browser console to inspect users node once
        function debugFetchUsersOnce() {
            rtdb.ref('users').once('value').then(snap => {
                console.log('debugFetchUsersOnce -> users:', snap.val());
            }).catch(err => console.error('debugFetchUsersOnce error', err));
        }
        // Show modal for admin to manage programs
        function showManageProgramsModal() {
            let modal = document.getElementById('manage-programs-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'manage-programs-modal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width:500px;">
                        <span class="close-modal" style="float:right;cursor:pointer;font-size:20px;">&times;</span>
                        <h3>Manage Programs</h3>
                        <div id="programs-list"></div>
                        <h4>Add New Program</h4>
                        <input type="text" id="new-program-id" placeholder="Program ID" style="width:45%;margin-bottom:5px;" />
                        <input type="text" id="new-program-name" placeholder="Program Name" style="width:45%;margin-bottom:5px;" />
                        <button id="add-program-btn">Add Program</button>
                    </div>
                `;
                document.body.appendChild(modal);
                // Close modal event
                modal.querySelector('.close-modal').onclick = () => { modal.style.display = 'none'; };
                window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
            }
            // Render program list
            function renderProgramsList() {
                const listDiv = document.getElementById('programs-list');
                listDiv.innerHTML = '';
                (state.programs || []).forEach(program => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '6px';
                    div.innerHTML = `<b>${program.id}</b>: ${program.name} <button data-id="${program.id}" class="edit-program-btn">Edit</button> <button data-id="${program.id}" class="delete-program-btn">Delete</button>`;
                    listDiv.appendChild(div);
                });
                // Edit and delete handlers
                listDiv.querySelectorAll('.edit-program-btn').forEach(btn => {
                    btn.onclick = function() {
                        const pid = this.getAttribute('data-id');
                        const program = (state.programs || []).find(p => p.id === pid);
                        if (!program) return;
                        const newName = prompt('Edit Program Name:', program.name);
                        if (newName && newName.trim()) {
                            rtdb.ref('programs/' + pid).update({ name: newName.trim() });
                        }
                    };
                });
                listDiv.querySelectorAll('.delete-program-btn').forEach(btn => {
                    btn.onclick = function() {
                        const pid = this.getAttribute('data-id');
                        if (confirm('Delete this program?')) {
                            rtdb.ref('programs/' + pid).remove();
                        }
                    };
                });
            }
            renderProgramsList();
            // Add program handler
            document.getElementById('add-program-btn').onclick = function() {
                const id = document.getElementById('new-program-id').value.trim();
                const name = document.getElementById('new-program-name').value.trim();
                if (!id || !name) {
                    alert('Enter both ID and Name');
                    return;
                }
                rtdb.ref('programs/' + id).set({ id, name });
                document.getElementById('new-program-id').value = '';
                document.getElementById('new-program-name').value = '';
            };
            // Refresh list on program changes
            rtdb.ref('programs').on('value', renderProgramsList);
            modal.style.display = 'flex';
        }
            }
        }

        // Load initial data (real-time classes, courses, and tasks)
        function loadInitialData() {
            // Load classes from Firebase
            rtdb.ref('classes').on('value', (snapshot) => {
                state.classes = Object.values(snapshot.val() || {});
                populateClassSelect();
            });
            // Load courses from Firebase
            rtdb.ref('courses').on('value', (snapshot) => {
                state.courses = Object.values(snapshot.val() || {});
                populateCourseSelect();
            });
            // Load tasks (assignments) from Firebase in real time
            rtdb.ref('tasks').on('value', (snapshot) => {
                state.tasks = Object.values(snapshot.val() || {});
                updateTasksUI();
            });
            // Load assignment submissions in real time
            rtdb.ref('submissions').on('value', (snapshot) => {
                state.submissions = Object.values(snapshot.val() || {});
                if (typeof updateAssignmentSubmissionsUI === 'function') updateAssignmentSubmissionsUI();
            });
        // Update assignment submissions UI (for students and lecturers)
        function updateAssignmentSubmissionsUI() {
            // For students: show submission status in assignments
            if (state.currentUser && state.currentUser.role === 'student') {
                const dashboardGrid = document.querySelector('.dashboard-grid');
                if (dashboardGrid) {
                    const assignmentsCard = dashboardGrid.querySelector('.dashboard-card:nth-child(2)');
                    if (assignmentsCard) {
                        // Add submission status to each assignment
                        assignmentsCard.querySelectorAll('.stat-item').forEach(item => {
                            const btn = item.querySelector('.submit-assignment-btn');
                            if (btn) {
                                const assignment = btn.getAttribute('data-assignment');
                                const course = btn.getAttribute('data-course');
                                const submitted = (state.submissions || []).some(s => s.assignment === assignment && s.course === course && s.student === state.currentUser.id);
                                let statusSpan = item.querySelector('.submission-status');
                                if (!statusSpan) {
                                    statusSpan = document.createElement('span');
                                    statusSpan.className = 'submission-status';
                                    statusSpan.style.marginLeft = '10px';
                                    item.appendChild(statusSpan);
                                }
                                statusSpan.textContent = submitted ? 'Submitted' : 'Not Submitted';
                                statusSpan.style.color = submitted ? 'green' : 'red';
                            }
                        });
                    }
                }
            }
            // For lecturers: could add a section to view all submissions per assignment (not implemented here)
        }
            // Load students from Firebase
            rtdb.ref('users').orderByChild('role').equalTo('student').on('value', (snapshot) => {
                state.students = Object.values(snapshot.val() || {});
            });
            // Load teaching records from Firebase (admin only)
            rtdb.ref('teachingRecords').on('value', (snapshot) => {
                state.teachingRecords = Object.values(snapshot.val() || {});
            });
            // Set current date for date inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('class-date').value = today;
            document.getElementById('attendance-date').value = today;
            // Set current time for time input (rounded to nearest hour)
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            document.getElementById('class-time').value = `${hours}:00`;
        }

        // Load user-specific data
        function loadUserData() {
            if (!state.currentUser) return;
            
            // Load chat messages
            loadChatMessages();
            
            // Load timetable
            updateTimetable();
            
            // Load results
            loadResults();
            
            // Load teaching records (admin only)
            if (state.currentUser.role === 'admin') {
                loadTeachingRecords();
            }
            
            // Load resources
            loadResources();

            // Subscribe to private unread counters for the logged-in user
            subscribePrivateUnreadForCurrentUser();
            // Render conversations inbox
            renderConversations();

            // New chat button
            const newBtn = document.getElementById('new-chat-btn');
            if (newBtn) newBtn.addEventListener('click', () => {
                const q = prompt('Enter user id or name to start a private chat with:');
                if (!q) return;
                // try to resolve
                const found = (state.students||[]).find(s=> String(s.id)===String(q) || (s.name||'').toLowerCase().includes(q.toLowerCase())) || (state.lecturers||[]).find(l=> String(l.id)===String(q) || (l.name||'').toLowerCase().includes(q.toLowerCase()));
                if (found && found.id) { openPrivateChat(found.id); return; }
                // fallback lookup
                rtdb.ref('users').orderByChild('name').startAt(q).endAt(q + "\uf8ff").once('value').then(snap => {
                    const vals = Object.values(snap.val() || {});
                    if (vals.length === 1) openPrivateChat(vals[0].id);
                    else if (vals.length > 1) openPrivateChat(vals[0].id);
                    else alert('No user found');
                }).catch(e=>{ console.warn(e); alert('Error searching users'); });
            });
            // keep conversations in sync
            rtdb.ref('privateChats').on('value', () => renderConversations());
            // set chat header from profile/program
            updateChatHeader();
        }

        // Load chat messages (group chat)
        // Load chat messages from Firebase Realtime Database
        function loadChatMessages() {
            const chatMessagesContainer = document.getElementById('chat-messages');
            chatMessagesContainer.innerHTML = '';
            // Attach realtime listener
            rtdb.ref('chatMessages').orderByChild('timestamp').on('value', (snapshot) => {
                const messages = snapshot.val() || {};
                // Sort messages by timestamp
                const sortedMessages = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
                // Save into state so forward/reply helpers can find messages
                state.chatMessages = sortedMessages;
                chatMessagesContainer.innerHTML = '';
                sortedMessages.forEach(msg => {
                    const messageElement = createMessageElement(msg);
                    chatMessagesContainer.appendChild(messageElement);
                });
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                // subscribe to reactions for the group chat
                subscribeReactionsForChat('chatMessages');
            });
        }

        // Create message element
        function createMessageElement(msg) {
            const messageElement = document.createElement('div');
            const isCurrentUser = msg.senderId === (state.currentUser && state.currentUser.id);

            messageElement.classList.add('message', isCurrentUser ? 'sent' : 'received');

            // Use data attributes for message id and attach event listeners later to avoid
            // injecting raw IDs into inline onclick handlers (which breaks when IDs are strings)
            let messageContent = `
                <div class="message-content">
                    <p>${msg.text || ''}</p>
                    <div class="message-actions">
                        <span class="message-action" data-action="forward" data-id="${msg.id}"><i class="fas fa-share"></i></span>
                        <span class="message-action" data-action="reply" data-id="${msg.id}"><i class="fas fa-reply"></i></span>
                    </div>
                </div>
                <div class="message-info">
                    <span>${msg.sender || ''} - ${formatTime(msg.timestamp)}</span>
                </div>
            `;

            if (msg.file) {
                messageContent = `
                    <div class="message-content">
                        <p>${msg.text || ''}</p>
                        <div class="file-message">
                            <div class="file-icon">
                                <i class="fas fa-file-${msg.file.type}"></i>
                            </div>
                            <div class="file-info">
                                <div class="file-name">${msg.file.name}</div>
                                <div class="file-size">${formatFileSize(msg.file.size)}</div>
                            </div>
                            <div class="file-download">
                                <i class="fas fa-download"></i>
                            </div>
                        </div>
                        <div class="message-actions">
                            <span class="message-action" data-action="forward" data-id="${msg.id}"><i class="fas fa-share"></i></span>
                            <span class="message-action" data-action="reply" data-id="${msg.id}"><i class="fas fa-reply"></i></span>
                        </div>
                    </div>
                    <div class="message-info">
                        <span>${msg.sender || ''} - ${formatTime(msg.timestamp)}</span>
                    </div>
                `;
            }

            messageElement.innerHTML = messageContent;

            // Attach action handlers safely
            try {
                const actions = messageElement.querySelectorAll('.message-action');
                actions.forEach(a => {
                    const action = a.getAttribute('data-action');
                    const id = a.getAttribute('data-id');
                    a.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (action === 'forward') forwardMessage(id);
                        else if (action === 'reply') replyToMessage(id);
                    });
                });
            } catch (e) {
                console.warn('Could not attach message action handlers', e);
            }

            // Render reactions if any and attach reaction handlers
            try {
                const reactionsContainer = document.createElement('div');
                reactionsContainer.className = 'reactions';
                const reactions = msg.reactions || {};
                // aggregate reactions by emoji
                Object.keys(reactions).forEach(emoji => {
                    const usersMap = reactions[emoji] || {};
                    const count = Object.keys(usersMap).length;
                    const r = document.createElement('div');
                    r.className = 'reaction';
                    r.innerHTML = `<span class="emoji">${emoji}</span> <span class="count">${count}</span>`;
                    r.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Determine chat path for reaction
                        const chatPath = messageElement.closest('#private-chat-messages') ? ('privateChats/' + state.currentPrivateChatId) : 'chatMessages';
                        sendReaction(chatPath, msg.id, emoji);
                    });
                    reactionsContainer.appendChild(r);
                });
                // quick picker to add a reaction
                const quick = document.createElement('div');
                quick.className = 'reaction';
                quick.style.padding = '4px';
                quick.textContent = '➕';
                quick.title = 'Add reaction';
                quick.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // open a small inline chooser
                    const picker = document.createElement('div');
                    picker.style.position = 'absolute'; picker.style.zIndex = 1200; picker.style.background = 'white'; picker.style.border = '1px solid #eee'; picker.style.padding = '6px'; picker.style.borderRadius = '8px';
                    ['😀','😂','😍','😮','😢','👍','🎉','🔥'].forEach(em => {
                        const b = document.createElement('span'); b.textContent = em; b.style.cursor = 'pointer'; b.style.padding = '4px'; b.style.margin = '2px';
                        b.addEventListener('click', (ev) => { const chatPath = messageElement.closest('#private-chat-messages') ? ('privateChats/' + state.currentPrivateChatId) : 'chatMessages'; sendReaction(chatPath, msg.id, em); picker.remove(); });
                        picker.appendChild(b);
                    });
                    document.body.appendChild(picker);
                    const rect = e.target.getBoundingClientRect(); picker.style.left = rect.left + 'px'; picker.style.top = (rect.top - 50) + 'px';
                    const close = () => { if (picker && picker.remove) picker.remove(); document.removeEventListener('click', close); };
                    setTimeout(() => document.addEventListener('click', close), 50);
                });
                reactionsContainer.appendChild(quick);
                messageElement.appendChild(reactionsContainer);
            } catch (e) { console.warn('reactions render failed', e); }

            return messageElement;
        }

        // Send message
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            const fileInput = document.getElementById('file-input');
            if (!message && fileInput.files.length === 0) return;
            const newMessageRef = rtdb.ref('chatMessages').push();
            const newMessage = {
                id: newMessageRef.key,
                text: message,
                sender: state.currentUser.name,
                senderId: state.currentUser.id,
                timestamp: Date.now(),
                file: fileInput.files.length > 0 ? {
                    name: fileInput.files[0].name,
                    type: fileInput.files[0].type.split('/')[1] || 'file',
                    size: fileInput.files[0].size
                } : null
            };
            newMessageRef.set(newMessage);
            messageInput.value = '';
            fileInput.value = '';
        }

        // Forward message
        function forwardMessage(messageId) {
            const message = state.chatMessages.find(m => m.id === messageId);
            if (!message) return;
            
            const forwardText = `Fwd: ${message.text}`;
            document.getElementById('message-input').value = forwardText;
            document.getElementById('message-input').focus();
        }

        // Reply to message
        function replyToMessage(messageId) {
            const message = state.chatMessages.find(m => m.id === messageId);
            if (!message) return;
            
            const replyText = `Re: ${message.text}`;
            document.getElementById('message-input').value = replyText;
            document.getElementById('message-input').focus();
        }

        // Helper: produce deterministic private chat id between two user ids
        function getPrivateChatId(a, b) {
            if (!a || !b) return null;
            return [String(a), String(b)].sort().join('__');
        }

        // Helper to open modal given a user object
        function _openPrivateChatWithUser(user) {
            if (!user || !state.currentUser) return;
            document.getElementById('private-chat-title').textContent = `Private Chat with ${user.name}`;
            const modal = document.getElementById('private-chat-modal');
            modal.setAttribute('data-recipient', user.id);
            modal.style.display = 'flex';
            // Load private messages (real-time)
            loadPrivateMessages(user.id);
        }

        // Open private chat by userId. If user is not present in local state, fetch from DB first.
        function openPrivateChat(userId) {
            if (!userId || !state.currentUser) return;
            let user = (state.students || []).find(s => String(s.id) === String(userId)) || (state.lecturers || []).find(l => String(l.id) === String(userId));
            if (user) {
                _openPrivateChatWithUser(user);
                return;
            }
            // Try onlineUsers cache first
            try {
                rtdb.ref('onlineUsers/' + userId).once('value').then(snap => {
                    const u = snap.val();
                    if (u && u.id) {
                        // cache in state lists according to role
                        if (u.role === 'student') {
                            if (!state.students) state.students = [];
                            if (!state.students.find(s => s.id === u.id)) state.students.push(u);
                        } else if (u.role === 'lecturer') {
                            if (!state.lecturers) state.lecturers = [];
                            if (!state.lecturers.find(l => l.id === u.id)) state.lecturers.push(u);
                        }
                        _openPrivateChatWithUser(u);
                    } else {
                        // fallback to users node
                        rtdb.ref('users/' + userId).once('value').then(snap2 => {
                            const u2 = snap2.val();
                            if (u2 && u2.id) {
                                if (u2.role === 'student') {
                                    if (!state.students) state.students = [];
                                    if (!state.students.find(s => s.id === u2.id)) state.students.push(u2);
                                } else if (u2.role === 'lecturer') {
                                    if (!state.lecturers) state.lecturers = [];
                                    if (!state.lecturers.find(l => l.id === u2.id)) state.lecturers.push(u2);
                                }
                                _openPrivateChatWithUser(u2);
                            } else {
                                console.warn('openPrivateChat: could not resolve userId', userId);
                                alert('Could not find user for private chat.');
                            }
                        }).catch(err2 => {
                            console.error('openPrivateChat users lookup failed', err2);
                            alert('Error opening private chat. See console.');
                        });
                    }
                }).catch(err => {
                    console.error('openPrivateChat onlineUsers lookup failed', err);
                    // final fallback to users
                    rtdb.ref('users/' + userId).once('value').then(snap2 => {
                        const u2 = snap2.val();
                        if (u2 && u2.id) {
                            if (u2.role === 'student') {
                                if (!state.students) state.students = [];
                                if (!state.students.find(s => s.id === u2.id)) state.students.push(u2);
                            } else if (u2.role === 'lecturer') {
                                if (!state.lecturers) state.lecturers = [];
                                if (!state.lecturers.find(l => l.id === u2.id)) state.lecturers.push(u2);
                            }
                            _openPrivateChatWithUser(u2);
                        } else {
                            console.warn('openPrivateChat fallback: could not resolve userId', userId);
                            alert('Could not find user for private chat.');
                        }
                    }).catch(err3 => {
                        console.error('openPrivateChat fallback users lookup failed', err3);
                        alert('Error opening private chat. See console.');
                    });
                });
            } catch (e) {
                console.error('openPrivateChat unexpected error', e);
            }
        }

        // Load private messages in real-time for the conversation between currentUser and userId
        function loadPrivateMessages(userId) {
            if (!state.currentUser || !userId) return;
            const privateChatContainer = document.getElementById('private-chat-messages');
            privateChatContainer.innerHTML = '';

            const chatId = getPrivateChatId(state.currentUser.id, userId);
            if (!chatId) return;

            // Detach previous listener for the previous private chat id
            try {
                if (state.currentPrivateChatId) rtdb.ref('privateChats/' + state.currentPrivateChatId).off('value');
            } catch (e) {}

            state.currentPrivateChatId = chatId;

            rtdb.ref('privateChats/' + chatId).orderByChild('timestamp').on('value', (snapshot) => {
                const msgsObj = snapshot.val() || {};
                const msgs = Object.values(msgsObj).sort((a,b) => a.timestamp - b.timestamp);
                privateChatContainer.innerHTML = '';
                msgs.forEach(m => {
                    const el = createMessageElement(m);
                    privateChatContainer.appendChild(el);
                });
                privateChatContainer.scrollTop = privateChatContainer.scrollHeight;
                // subscribe to reactions for this private chat
                subscribeReactionsForChat('privateChats/' + chatId);
            });

            // mark messages as read for this user (set readBy flag)
            try {
                rtdb.ref('privateChats/' + chatId).once('value').then(snap => {
                    const msgs = snap.val() || {};
                    Object.keys(msgs).forEach(mid => {
                        try { rtdb.ref(`privateChats/${chatId}/${mid}/readBy/${state.currentUser.id}`).set({ userId: state.currentUser.id, ts: Date.now() }); } catch(e){}
                    });
                }).catch(e=>{});
            } catch (e) {}

            // populate recipient meta (avatar, last seen)
            try {
                const avatarEl = document.getElementById('private-recipient-avatar');
                const lastSeenEl = document.getElementById('private-last-seen');
                const typingEl = document.getElementById('private-typing-indicator');
                // fetch user profile
                rtdb.ref('users/' + userId).once('value').then(snap => {
                    const u = snap.val() || {};
                    if (avatarEl) avatarEl.textContent = (u.name && u.name.charAt(0).toUpperCase()) || 'U';
                    if (lastSeenEl) lastSeenEl.textContent = u.lastActive ? new Date(u.lastActive).toLocaleString() : 'unknown';
                }).catch(()=>{});

                // subscribe to typing for this private conversation
                const typingPath = `typing/private:${userId}`;
                rtdb.ref(typingPath).on('value', snap => {
                    const obj = snap.val() || {};
                    const names = Object.values(obj).map(o=>o.name).filter(n=>n!==state.currentUser.name);
                    if (typingEl) typingEl.textContent = names.length ? (names.join(', ') + (names.length===1 ? ' is typing...' : ' are typing...')) : '';
                });
            } catch (e) { console.warn('private meta error', e); }

            // Clear unread counter for this chat for the current user
            try {
                const path = `privateUnread/${state.currentUser.id}/${chatId}`;
                rtdb.ref(path).remove();
            } catch (e) { console.warn('Could not clear unread counter', e); }
        }

        // Send private message (writes to RTDB under privateChats/{chatId})
        function sendPrivateMessage() {
            const messageInput = document.getElementById('private-message-input');
            const message = messageInput.value.trim();

            if (!message || !state.currentUser) return;

            // Prefer the tracked currentPrivateChatId
            const modal = document.getElementById('private-chat-modal');
            const recipientId = modal ? modal.getAttribute('data-recipient') : null;
            const chatId = state.currentPrivateChatId || (recipientId ? getPrivateChatId(state.currentUser.id, recipientId) : null);
            if (!chatId) return;

            const newMessageRef = rtdb.ref('privateChats/' + chatId).push();
            const newMessage = {
                id: newMessageRef.key,
                text: message,
                sender: state.currentUser.name,
                senderId: state.currentUser.id,
                timestamp: Date.now()
            };

            newMessageRef.set(newMessage);
            // update sender's last active timestamp
            try { rtdb.ref('users/' + state.currentUser.id).update({ lastActive: Date.now() }); } catch(e){}
            messageInput.value = '';

            // Increment unread counter for recipient (so they see badge)
            try {
                const recipient = recipientId;
                if (recipient && recipient !== state.currentUser.id) {
                    const unreadPath = `privateUnread/${recipient}/${chatId}`;
                    // Use a transaction to increment safely
                    const ref = rtdb.ref(unreadPath);
                    ref.transaction(current => {
                        if (!current) return { count: 1, lastTimestamp: Date.now(), chatId: chatId };
                        current.count = (current.count || 0) + 1;
                        current.lastTimestamp = Date.now();
                        return current;
                    });
                    // Do not send a generic notification for private messages; private unread is tracked separately
                }
            } catch (e) { console.error('Could not increment unread counter', e); }
        }

        // Helper: parse a time range like "9:00 - 10:00" into {start: Date, end: Date}
        function parseTimeRangeToToday(rangeStr) {
            if (!rangeStr) return null;
            const parts = rangeStr.split('-').map(p => p.trim());
            if (parts.length !== 2) return null;
            const now = new Date();
            const [s,h] = parts[0].split(':');
            const [e,he] = parts[1].split(':');
            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(parts[0].split(':')[0],10), parseInt(parts[0].split(':')[1]||0,10));
            const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(parts[1].split(':')[0],10), parseInt(parts[1].split(':')[1]||0,10));
            return { start, end };
        }

        // Helper: returns true if the given time range and day index correspond to "now"
        // dayIndex: 0 = Monday ... 4 = Friday
        function isTimeRangeNow(rangeStr, dayIndex) {
            try {
                const range = parseTimeRangeToToday(rangeStr);
                if (!range) return false;
                const today = new Date();
                // map JS Sunday(0)-Saturday(6) to our 0..4 (Mon-Fri)
                const jsDay = today.getDay(); // 0..6
                const mapToIndex = (d) => {
                    if (d === 0) return -1; // Sunday
                    return d - 1; // Monday -> 0
                };
                const currentIndex = mapToIndex(jsDay);
                if (dayIndex !== currentIndex) return false;
                const now = today.getTime();
                return now >= range.start.getTime() && now <= range.end.getTime();
            } catch (e) { return false; }
        }

        // Map internal status to friendly label and css class
        function mapStatusDisplay(statusRaw) {
            const s = (statusRaw || 'scheduled').toLowerCase();
            switch (s) {
                case 'ongoing': return { label: 'In Progress', cls: 'status-ongoing' };
                case 'scheduled': return { label: 'Will be available', cls: 'status-scheduled' };
                case 'cancelled': return { label: 'Not Available', cls: 'status-cancelled' };
                case 'makeup': return { label: 'Make-up', cls: 'status-makeup' };
                default: return { label: s.charAt(0).toUpperCase() + s.slice(1), cls: 'status-unknown' };
            }
        }

        // Update timetable
        // Update timetable from Firebase Realtime Database
        function updateTimetable() {
            // Read controls, but fallback to currentUser profile for students if controls are empty/disabled
            let program = document.getElementById('program-select').value;
            let year = document.getElementById('year-select').value;
            let semester = document.getElementById('semester-select').value;
            const user = state.currentUser || {};
            // If a student and values are not set, prefer profile values
            if (user.role === 'student') {
                if (!program || program === '') program = user.program || program;
                if (!year || year === '') year = user.year || year;
                if (!semester || semester === '') semester = user.semester || semester;
            }
            const timetableBody = document.getElementById('timetable-body');
            timetableBody.innerHTML = '';
            // Avoid duplicate listeners
            rtdb.ref('timetable').off('value');
            rtdb.ref('timetable').on('value', (snapshot) => {
                const timetable = snapshot.val() || {};
                const timeSlots = [
                    '9:00 - 10:00', '10:00 - 11:00', '11:00 - 12:00',
                    '12:00 - 13:00', '13:00 - 14:00', '14:00 - 15:00'
                ];

                // Build a map for quick lookup by keys
                const timetableEntries = Object.entries(timetable || {}).map(([k,v]) => Object.assign({ key: k }, v));

                // Normalize selected program to an ID where possible
                const selectedProgramId = program ? resolveProgramId(program) : '';

                // Render rows
                timeSlots.forEach(time => {
                    const row = document.createElement('tr');
                    const timeCell = document.createElement('td');
                    timeCell.className = 'time-cell';
                    timeCell.textContent = time;
                    row.appendChild(timeCell);
                    for (let i = 0; i < 5; i++) {
                        const dayCell = document.createElement('td');
                        dayCell.className = 'empty-cell';
                        const entry = timetableEntries.find(e => {
                            const entryProgramId = resolveProgramId(e.program || '');
                            const matchProgram = !selectedProgramId || selectedProgramId === '' ? true : (entryProgramId === selectedProgramId);
                            const matchYear = !year || year === '' ? true : (String(e.year) == String(year));
                            const matchSemester = !semester || semester === '' ? true : (String(e.semester) == String(semester));
                            // Be tolerant: day may be stored as string or number; time may have extra whitespace
                            const entryDay = (typeof e.day !== 'undefined' && e.day !== null) ? Number(e.day) : null;
                            const entryTime = (e.time || '').toString().trim();
                            return entryTime === time && entryDay === i && matchProgram && matchYear && matchSemester;
                        });
                        if (entry) {
                            // Resolve course code and friendly name if possible
                            const course = (state.courses || []).find(c => (c.id && String(c.id) === String(entry.subject)) || (c.name && String(c.name).toLowerCase() === String(entry.subject).toLowerCase()));
                            const courseCode = course && course.id ? course.id : (entry.code || '');
                            const courseName = course && course.name ? course.name : (entry.subject || '');

                            // Determine if the slot is happening now (same day and current time within range)
                            const nowFlag = isTimeRangeNow(entry.time || '', entry.day);

                            // Determine display status (lecturer-driven status overrides scheduled detect)
                            const baseStatus = entry.status || 'scheduled';
                            const mapped = mapStatusDisplay(baseStatus);
                            let displayLabel = mapped.label;
                            let statusClass = mapped.cls;
                            if (nowFlag && baseStatus !== 'cancelled') {
                                displayLabel = 'In Progress';
                                statusClass = 'status-ongoing in-progress';
                            }

                            // Lecturer avatar (initial)
                            const lecturerInitial = (entry.lecturer || 'T').charAt(0).toUpperCase();
                            dayCell.className = `class-cell ${statusClass}`;
                            dayCell.innerHTML = `
                                <div class="cell-top">
                                    <div class="cell-subject"><strong>${courseName}</strong> <span class="course-code">${courseCode ? '['+courseCode+']' : ''}</span></div>
                                    <div class="cell-meta">
                                        <span class="cell-location">${entry.location || ''}</span>
                                        <span class="cell-status-badge" title="${baseStatus}">${displayLabel}</span>
                                    </div>
                                </div>
                                <div class="cell-bottom">
                                    <div class="lecturer">
                                        <div class="lecturer-avatar">${lecturerInitial}</div>
                                        <div class="lecturer-name">${entry.lecturer || ''}</div>
                                    </div>
                                    <div class="cell-actions">` + (state.currentUser && state.currentUser.role === 'admin' ? `
                                        <button class="inline-edit" data-key="${entry.key}">✏️</button>
                                        <button class="inline-delete" data-key="${entry.key}">🗑️</button>
                                    ` : '') + `</div>
                                </div>
                            `;

                            // Student click opens resources for the subject
                            dayCell.addEventListener('click', (ev) => {
                                // if admin clicked action buttons, ignore
                                if (ev.target && (ev.target.classList.contains('inline-edit') || ev.target.classList.contains('inline-delete'))) return;
                                if (state.currentUser && state.currentUser.role === 'student') {
                                    viewCourseResources(entry.subject);
                                } else {
                                    // show detailed view modal for other roles
                                    showTimetableEntryDetails(entry);
                                }
                            });
                        }
                        row.appendChild(dayCell);
                    }
                    timetableBody.appendChild(row);
                });

                // Wire inline admin actions after render
                timetableBody.querySelectorAll('.inline-edit').forEach(btn => {
                    btn.onclick = function(e) {
                        e.stopPropagation();
                        const key = this.getAttribute('data-key');
                        openManageTimetableForEdit(key);
                    };
                });
                timetableBody.querySelectorAll('.inline-delete').forEach(btn => {
                    btn.onclick = function(e) {
                        e.stopPropagation();
                        const key = this.getAttribute('data-key');
                        if (confirm('Delete this timetable entry?')) {
                            rtdb.ref('timetable/' + key).once('value', s => {
                                const eobj = s.val() || {};
                                rtdb.ref('timetable/' + key).remove();
                                broadcastTimetableChange(eobj.program || 'all', 'Deleted', eobj.subject || '', eobj.time || '');
                            });
                        }
                    };
                });
            });
            // Update week display
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (state.currentWeekOffset * 7));
            const options = { month: 'long', day: 'numeric', year: 'numeric' };
            document.getElementById('week-display').textContent = `Week of ${startOfWeek.toLocaleDateString(undefined, options)}`;
        }

        // View course resources
        function viewCourseResources(courseName) {
            // Switch to resources tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-tab="resources"]').classList.add('active');
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('resources-section').classList.add('active');
            
            // Filter resources for this course
            loadResources(courseName);
        }

        // Update timetable status and details (lecturer only)
        function updateTimetableStatus() {
            const classSelect = document.getElementById('class-select').value;
            const classDate = document.getElementById('class-date').value;
            const classTime = document.getElementById('class-time').value;
            const classStatus = document.getElementById('class-status').value;
            const classLecturer = state.currentUser ? state.currentUser.name : '';
            // Only allow updating status for existing classes, or creating new make-up classes
            rtdb.ref('timetable').once('value', (snapshot) => {
                const timetable = snapshot.val() || {};
                const classKey = Object.keys(timetable).find(key => {
                    const c = timetable[key];
                    return c.subject === classSelect && c.time === classTime;
                });
                if (classKey) {
                    // Only allow status update
                    rtdb.ref('timetable/' + classKey).update({
                        status: classStatus
                    });
                    // Notify about class status update
                    sendNotification({
                        title: 'Class Status Updated',
                        message: `${classSelect} on ${classDate} at ${classTime} is now ${classStatus}`
                    });
                    const toast = document.createElement('div');
                    toast.textContent = `Class status updated (${classSelect})`;
                    toast.style.position = 'fixed'; toast.style.right = '20px'; toast.style.bottom = '20px';
                    toast.style.background = 'rgba(0,0,0,0.8)'; toast.style.color = 'white';
                    toast.style.padding = '10px 14px'; toast.style.borderRadius = '6px';
                    document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000);
                } else if (classStatus === 'makeup') {
                    // Only allow creation of new class if it's a make-up class
                    const newClass = {
                        subject: classSelect,
                        date: classDate,
                        time: classTime,
                        status: classStatus,
                        lecturer: classLecturer
                    };
                    rtdb.ref('timetable').push(newClass);
                    sendNotification({
                        title: 'Make-up Class Created',
                        message: `Make-up: ${classSelect} on ${classDate} at ${classTime}`
                    });
                    const toast2 = document.createElement('div');
                    toast2.textContent = 'Make-up class created';
                    toast2.style.position = 'fixed'; toast2.style.right = '20px'; toast2.style.bottom = '20px';
                    toast2.style.background = 'rgba(0,0,0,0.8)'; toast2.style.color = 'white';
                    toast2.style.padding = '10px 14px'; toast2.style.borderRadius = '6px';
                    document.body.appendChild(toast2); setTimeout(() => toast2.remove(), 3000);
                } else {
                    const toast3 = document.createElement('div');
                    toast3.textContent = 'Cannot update status: invalid operation';
                    toast3.style.position = 'fixed'; toast3.style.right = '20px'; toast3.style.bottom = '20px';
                    toast3.style.background = 'rgba(0,0,0,0.8)'; toast3.style.color = 'white';
                    toast3.style.padding = '10px 14px'; toast3.style.borderRadius = '6px';
                    document.body.appendChild(toast3); setTimeout(() => toast3.remove(), 3000);
                }
            });
        }

        // Show attendance modal
        function showAttendanceModal() {
            const attendanceList = document.getElementById('attendance-list');
            attendanceList.innerHTML = '';
            
            // Populate with students
            state.students.forEach(student => {
                const studentItem = document.createElement('div');
                studentItem.className = 'student-attendance';
                studentItem.style.padding = '10px';
                studentItem.style.borderBottom = '1px solid #eee';
                
                studentItem.innerHTML = `
                    <label>
                        <input type="checkbox" checked> ${student.name} (${student.id})
                    </label>
                `;
                
                attendanceList.appendChild(studentItem);
            });
            
            // Show modal
            document.getElementById('attendance-modal').style.display = 'flex';
        }

        // Submit attendance
        function submitAttendance() {
            const classSelect = document.getElementById('attendance-class').value;
            const date = document.getElementById('attendance-date').value;
            // Get checked students
            const checkboxes = document.querySelectorAll('#attendance-list input[type="checkbox"]');
            const presentStudents = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.parentElement.textContent.trim().split(' (')[0]);
            // Save attendance record to Firebase
            const attendanceRecord = {
                class: classSelect,
                date: date,
                present: presentStudents
            };
            rtdb.ref('attendanceRecords/' + Date.now()).set(attendanceRecord);
            // Close modal
            document.getElementById('attendance-modal').style.display = 'none';
            sendNotification({
                title: 'Attendance Recorded',
                message: `${presentStudents.length} students present for ${classSelect} on ${date}`
            });
            const toast = document.createElement('div');
            toast.textContent = `Attendance recorded (${presentStudents.length} present)`;
            toast.style.position = 'fixed'; toast.style.right = '20px'; toast.style.bottom = '20px';
            toast.style.background = 'rgba(0,0,0,0.8)'; toast.style.color = 'white';
            toast.style.padding = '10px 14px'; toast.style.borderRadius = '6px';
            document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000);
        }

        // Load results
        // Load results from Firebase Realtime Database
        function loadResults() {
            const resultsBody = document.getElementById('results-table').querySelector('tbody');
            resultsBody.innerHTML = '';
            rtdb.ref('results').on('value', (snapshot) => {
                const courses = snapshot.val() || {};
                let totalCredits = 0;
                let totalGradePoints = 0;
                Object.values(courses).forEach(course => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${course.code}</td>
                        <td>${course.name}</td>
                        <td>${course.credits}</td>
                        <td><span class="grade ${course.grade.toLowerCase()}">${course.grade}</span></td>
                        <td>${course.status}</td>
                    `;
                    resultsBody.appendChild(row);
                    if (course.status === 'Completed') {
                        totalCredits += course.credits;
                        totalGradePoints += course.credits * gradeToPoint(course.grade);
                    }
                });
                const gpa = totalCredits > 0 ? (totalGradePoints / totalCredits).toFixed(2) : 0;
                document.getElementById('total-credits').textContent = totalCredits;
                document.getElementById('gpa').textContent = gpa;
                document.getElementById('academic-status').textContent = getAcademicStatus(gpa);
            });
        }

        // Save grade (lecturer only)
        function saveGrade() {
            const course = document.getElementById('course-select').value;
            const assignment = document.getElementById('assignment-select').value;
            const student = document.getElementById('student-select').value;
            const grade = document.getElementById('grade-input').value;
            const dueDate = document.getElementById('due-date-input').value;
            if (!grade) {
                alert('Please enter a grade');
                return;
            }
            // Save to Firebase Realtime Database
            const newResult = {
                code: course,
                assignment: assignment,
                student: student,
                grade: grade,
                status: 'Completed',
                credits: 3,
                name: course,
                dueDate: dueDate
            };
            rtdb.ref('results/' + Date.now()).set(newResult);
            document.getElementById('grade-input').value = '';
            document.getElementById('due-date-input').value = '';
            sendNotification({
                title: 'Grade Posted',
                message: `Grade ${grade} posted for ${student} in ${course} - ${assignment}`
            });
            const toast = document.createElement('div');
            toast.textContent = `Grade saved for ${student}`;
            toast.style.position = 'fixed'; toast.style.right = '20px'; toast.style.bottom = '20px';
            toast.style.background = 'rgba(0,0,0,0.8)'; toast.style.color = 'white';
            toast.style.padding = '10px 14px'; toast.style.borderRadius = '6px';
            document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000);
        }

        // Export grades (lecturer only)
        function exportGrades() {
            const course = document.getElementById('course-select').value;
            sendNotification({
                title: 'Grades Exported',
                message: `Grades for ${course} were exported by ${state.currentUser ? state.currentUser.name : 'admin'}`
            });
            const toast = document.createElement('div');
            toast.textContent = `Grades exported for ${course}`;
            toast.style.position = 'fixed'; toast.style.right = '20px'; toast.style.bottom = '20px';
            toast.style.background = 'rgba(0,0,0,0.8)'; toast.style.color = 'white';
            toast.style.padding = '10px 14px'; toast.style.borderRadius = '6px';
            document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000);
        }

        // Load resources
        // Load resources from Firebase Realtime Database
        function loadResources(courseFilter = null) {
            const resourcesGrid = document.getElementById('resources-grid');
            resourcesGrid.innerHTML = '';
            rtdb.ref('resources').on('value', (snapshot) => {
                let resources = snapshot.val() || {};
                let resourcesToShow = Object.values(resources);
                if (courseFilter) {
                    resourcesToShow = resourcesToShow.filter(r => r.course === courseFilter);
                }
                if (resourcesToShow.length === 0) {
                    resourcesGrid.innerHTML = '<p>No resources available for this course.</p>';
                    return;
                }
                resourcesToShow.forEach(resource => {
                    const resourceCard = document.createElement('div');
                    resourceCard.className = 'resource-card';
                    resourceCard.innerHTML = `
                        <div class="resource-icon">
                            <i class="fas fa-file-${resource.type === 'Video Lecture' ? 'video' : 'pdf'}"></i>
                        </div>
                        <div class="resource-name">${resource.title}</div>
                        <div class="resource-info">
                            <div>Course: ${resource.course}</div>
                            <div>Type: ${resource.type}</div>
                            <div>Added: ${resource.date}</div>
                        </div>
                        <div class="resource-actions">
                            <button class="btn-primary"><i class="fas fa-download"></i> Download</button>
                            ${state.currentUser.role === 'lecturer' ? 
                                `<button class="btn-secondary" onclick="deleteResource(${resource.id})"><i class="fas fa-trash"></i> Delete</button>` : ''
                            }
                        </div>
                    `;
                    resourcesGrid.appendChild(resourceCard);
                });
            });
        }

        // Add resource (lecturer only)
        function addResource() {
            const course = document.getElementById('resource-course').value;
            const title = document.getElementById('resource-title').value;
            const type = document.getElementById('resource-type').value;
            const fileInput = document.getElementById('resource-file');
            if (!course || !title || !type || fileInput.files.length === 0) {
                alert('Please fill in all fields and select a file');
                return;
            }
            const newResource = {
                id: Date.now(),
                course: course,
                title: title,
                type: type,
                date: new Date().toLocaleDateString(),
                file: fileInput.files[0].name
            };
            // Save to Firebase Realtime Database
            rtdb.ref('resources/' + newResource.id).set(newResource);
            // Notify users
            sendNotification({
                title: 'New Resource',
                message: `${newResource.title} (${newResource.type}) for ${newResource.course} was added`
            });
            // Clear form
            document.getElementById('resource-title').value = '';
            fileInput.value = '';
            const toast = document.createElement('div');
            toast.textContent = 'Resource added and users notified';
            toast.style.position = 'fixed';
            toast.style.right = '20px';
            toast.style.bottom = '20px';
            toast.style.background = 'rgba(0,0,0,0.8)';
            toast.style.color = 'white';
            toast.style.padding = '10px 14px';
            toast.style.borderRadius = '6px';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Delete resource (lecturer only)
        function deleteResource(resourceId) {
            if (!confirm('Are you sure you want to delete this resource?')) return;
            // Remove from Firebase Realtime Database
            rtdb.ref('resources/' + resourceId).remove();
            sendNotification({
                title: 'Resource Removed',
                message: `A resource was removed by ${state.currentUser ? state.currentUser.name : 'admin'}`
            });
            const toast = document.createElement('div');
            toast.textContent = 'Resource deleted';
            toast.style.position = 'fixed';
            toast.style.right = '20px';
            toast.style.bottom = '20px';
            toast.style.background = 'rgba(0,0,0,0.8)';
            toast.style.color = 'white';
            toast.style.padding = '10px 14px';
            toast.style.borderRadius = '6px';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        // Load teaching records (admin only)
        function loadTeachingRecords() {
            const recordsBody = document.getElementById('teaching-records');
            recordsBody.innerHTML = '';
            
            state.teachingRecords.forEach(record => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${record.lecturer}</td>
                    <td>${record.course}</td>
                    <td>${record.date}</td>
                    <td>${record.duration}</td>
                    <td>${record.attendance}%</td>
                `;
                
                recordsBody.appendChild(row);
            });
        }

        // Utility functions

        // Update tasks UI in dashboard and other places
        function updateTasksUI() {
            // Student: Upcoming Assignments
            if (state.currentUser && state.currentUser.role === 'student') {
                const dashboardGrid = document.querySelector('.dashboard-grid');
                if (dashboardGrid) {
                    // Show all assignments for the student's courses
                    const assignments = state.tasks.filter(t => t.role === 'student' && (!t.userId || t.userId === state.currentUser.id));
                    const assignmentsHtml = assignments.map(task => {
                        let dueDateText = task.dueDate ? `Due: ${task.dueDate}` : '';
                        return `
                            <div class="stat-item">
                                <span>${task.title || task.assignment || 'Assignment'}</span>
                                <span>${dueDateText}</span>
                                <button class="submit-assignment-btn" data-assignment="${task.assignment || ''}" data-course="${task.course || ''}">Submit</button>
                            </div>
                        `;
                    }).join('');
                    // Replace the assignments card if it exists
                    const assignmentsCard = dashboardGrid.querySelector('.dashboard-card:nth-child(2)');
                    if (assignmentsCard) {
                        assignmentsCard.innerHTML = `
                            <h3><i class="fas fa-tasks"></i> Upcoming Assignments</h3>
                            ${assignmentsHtml || '<div class="stat-item">No assignments</div>'}
                        `;
                    }
                }
            }
            // Add event listeners for assignment submission buttons (student)
            if (state.currentUser && state.currentUser.role === 'student') {
                setTimeout(() => {
                    document.querySelectorAll('.submit-assignment-btn').forEach(btn => {
                        btn.onclick = function() {
                            const assignment = this.getAttribute('data-assignment');
                            const course = this.getAttribute('data-course');
                            showAssignmentSubmissionModal(assignment, course);
                        };
                    });
                }, 100);
            }
        // Show assignment submission modal (student)
        function showAssignmentSubmissionModal(assignment, course) {
            // Create modal if not exists
            let modal = document.getElementById('assignment-submit-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'assignment-submit-modal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width:400px;">
                        <span class="close-modal" style="float:right;cursor:pointer;font-size:20px;">&times;</span>
                        <h3>Submit Assignment</h3>
                        <div id="assignment-modal-info"></div>
                        <input type="file" id="assignment-file-input" accept=".pdf,.doc,.docx,.txt,.zip,.rar,.jpg,.png" style="margin:10px 0;" />
                        <button id="submit-assignment-file-btn">Submit</button>
                    </div>
                `;
                document.body.appendChild(modal);
                // Close modal event
                modal.querySelector('.close-modal').onclick = () => { modal.style.display = 'none'; };
                window.addEventListener('click', (e) => {
                    if (e.target === modal) modal.style.display = 'none';
                });
            }
            // Set info
            document.getElementById('assignment-modal-info').innerHTML = `<b>Assignment:</b> ${assignment || ''}<br><b>Course:</b> ${course || ''}`;
            // Show modal
            modal.style.display = 'flex';
            // Submit button event
            document.getElementById('submit-assignment-file-btn').onclick = function() {
                const fileInput = document.getElementById('assignment-file-input');
                if (!fileInput.files.length) {
                    alert('Please select a file to submit.');
                    return;
                }
                const file = fileInput.files[0];
                const userId = state.currentUser.id;
                const storageRef = firebase.storage().ref(`submissions/${course}/${assignment}/${userId}_${file.name}`);
                const uploadTask = storageRef.put(file);
                uploadTask.on('state_changed', null, function(error) {
                    alert('Upload failed: ' + error.message);
                }, function() {
                    uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                        // Save submission record in Firebase
                        const submission = {
                            assignment: assignment,
                            course: course,
                            student: userId,
                            fileName: file.name,
                            fileUrl: downloadURL,
                            timestamp: Date.now()
                        };
                        firebase.database().ref('submissions').push(submission);
                        // Notify lecturer(s) about new submission
                        sendNotification({
                            title: 'Assignment Submitted',
                            message: `${state.currentUser ? state.currentUser.name : 'A student'} submitted ${assignment} for ${course}`
                        });
                        modal.style.display = 'none';
                        const toast = document.createElement('div');
                        toast.textContent = 'Assignment submitted successfully';
                        toast.style.position = 'fixed'; toast.style.right = '20px'; toast.style.bottom = '20px';
                        toast.style.background = 'rgba(0,0,0,0.8)'; toast.style.color = 'white';
                        toast.style.padding = '10px 14px'; toast.style.borderRadius = '6px';
                        document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000);
                    });
                });
            };
        }
            // Lecturer: Teaching Tasks
            if (state.currentUser && state.currentUser.role === 'lecturer') {
                const dashboardGrid = document.querySelector('.dashboard-grid');
                if (dashboardGrid) {
                    const teachingTasks = state.tasks.filter(t => t.role === 'lecturer' && t.userId === state.currentUser.id);
                    const teachingHtml = teachingTasks.map(task => `
                        <div class="stat-item">
                            <span>${task.title}</span>
                            <span>${task.count ? task.count : ''}</span>
                        </div>
                    `).join('');
                    // Replace the teaching tasks card if it exists
                    const teachingCard = dashboardGrid.querySelector('.dashboard-card:nth-child(2)');
                    if (teachingCard) {
                        teachingCard.innerHTML = `
                            <h3><i class="fas fa-tasks"></i> Teaching Tasks</h3>
                            ${teachingHtml || '<div class="stat-item">No tasks</div>'}
                        `;
                    }
                }
            }
            // Admin: Administrative Tasks
            if (state.currentUser && state.currentUser.role === 'admin') {
                const dashboardGrid = document.querySelector('.dashboard-grid');
                if (dashboardGrid) {
                    const adminTasks = state.tasks.filter(t => t.role === 'admin');
                    const adminHtml = adminTasks.map(task => `
                        <div class="stat-item">
                            <span>${task.title}</span>
                            <span>${task.count ? task.count : ''}</span>
                        </div>
                    `).join('');
                    // Replace the admin tasks card if it exists
                    const adminCard = dashboardGrid.querySelector('.dashboard-card:nth-child(2)');
                    if (adminCard) {
                        adminCard.innerHTML = `
                            <h3><i class="fas fa-tasks"></i> Administrative Tasks</h3>
                            ${adminHtml || '<div class="stat-item">No tasks</div>'}
                        `;
                    }
                }
            }
        }
        // Populate program select dropdowns with real-time programs
        function populateProgramSelect() {
            const programSelect = document.getElementById('program-select');
            if (programSelect && state.programs.length > 0) {
                programSelect.innerHTML = '';
                state.programs.forEach(program => {
                    const option = document.createElement('option');
                    option.value = program.id;
                    option.textContent = program.name;
                    programSelect.appendChild(option);
                });
            }
            // Also update registration form if needed
            const regProgramSelect = document.getElementById('reg-program');
            if (regProgramSelect && state.programs.length > 0) {
                regProgramSelect.innerHTML = '<option value="">Select Program</option>';
                state.programs.forEach(program => {
                    const option = document.createElement('option');
                    option.value = program.id;
                    option.textContent = program.name;
                    regProgramSelect.appendChild(option);
                });
            }
            // ensure chat header reflects program options
            updateChatHeader();
        }

        // Helper: normalize program identifier (accept id or name)
        function resolveProgramId(value) {
            if (!value) return '';
            const programs = state.programs || [];
            // if matches an id directly
            const byId = programs.find(p => p.id === value);
            if (byId) return byId.id;
            // if matches name, return its id
            const byName = programs.find(p => p.name === value);
            if (byName) return byName.id;
            // otherwise return the raw value
            return value;
        }

        // Helper: resolve program name from id or name
        function resolveProgramName(value) {
            if (!value) return '';
            const programs = state.programs || [];
            const byId = programs.find(p => String(p.id) === String(value));
            if (byId) return byId.name || '';
            const byName = programs.find(p => (p.name || '').toLowerCase() === String(value).toLowerCase());
            if (byName) return byName.name || '';
            return String(value);
        }

        // Update the group chat header to reflect the selected program of study
        function updateChatHeader() {
            try {
                const headerEl = document.querySelector('.chat-header h3');
                if (!headerEl) return;
                // prefer student's profile program when role is student
                let programName = '';
                if (state.currentUser && state.currentUser.role === 'student') {
                    // state.currentUser.program may be an id; try to resolve friendly name
                    programName = resolveProgramName(state.currentUser.program) || state.currentUser.program || '';
                }
                // otherwise prefer selected program from UI
                if (!programName) {
                    const sel = document.getElementById('program-select');
                    const val = sel ? sel.value : '';
                    programName = resolveProgramName(val) || '';
                }
                if (!programName) programName = 'Class';
                headerEl.textContent = `${programName} Group`;
            } catch (e) { console.warn('updateChatHeader error', e); }
        }

        // Populate class select dropdowns with real-time classes
        function populateClassSelect() {
            const classSelect = document.getElementById('class-select');
            if (classSelect && state.classes && state.classes.length > 0) {
                classSelect.innerHTML = '';
                state.classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    classSelect.appendChild(option);
                });
            }
            // Attendance modal class dropdown
            const attendanceClassSelect = document.getElementById('attendance-class');
            if (attendanceClassSelect && state.classes && state.classes.length > 0) {
                attendanceClassSelect.innerHTML = '';
                state.classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    attendanceClassSelect.appendChild(option);
                });
            }
        }

        // Populate course select dropdowns with real-time courses
        function populateCourseSelect() {
            // If a program is selected, filter courses to that program
            const programSelectElem = document.getElementById('program-select');
            const selectedProgram = programSelectElem ? programSelectElem.value : null;

            const filteredCourses = (state.courses || []).filter(c => {
                if (!selectedProgram || selectedProgram === '') return true;
                return (c.program || '') === selectedProgram;
            });

            const courseSelect = document.getElementById('course-select');
            if (courseSelect) {
                courseSelect.innerHTML = '';
                if (filteredCourses.length === 0) {
                    const opt = document.createElement('option'); opt.value = ''; opt.textContent = 'No courses available'; courseSelect.appendChild(opt);
                } else {
                    filteredCourses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.code || course.id;
                        option.textContent = course.name;
                        courseSelect.appendChild(option);
                    });
                }
            }
            // Resource management course dropdown
            const resourceCourseSelect = document.getElementById('resource-course');
            if (resourceCourseSelect) {
                resourceCourseSelect.innerHTML = '';
                if (filteredCourses.length === 0) {
                    const opt = document.createElement('option'); opt.value = ''; opt.textContent = 'No courses available'; resourceCourseSelect.appendChild(opt);
                } else {
                    filteredCourses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.code || course.id;
                        option.textContent = course.name;
                        resourceCourseSelect.appendChild(option);
                    });
                }
            }
            // Also update any assignment/course pickers that rely on state.courses
            const assignmentCourseSelect = document.getElementById('assignment-course-input');
            if (assignmentCourseSelect) {
                assignmentCourseSelect.innerHTML = '';
                if (filteredCourses.length === 0) {
                    const opt = document.createElement('option'); opt.value = ''; opt.textContent = 'No courses available'; assignmentCourseSelect.appendChild(opt);
                } else {
                    filteredCourses.forEach(course => {
                        const opt = document.createElement('option'); opt.value = course.code || course.id; opt.textContent = course.name; assignmentCourseSelect.appendChild(opt);
                    });
                }
            }
        }
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function gradeToPoint(grade) {
            const scale = { 'A': 4.0, 'A-': 3.7, 'B+': 3.3, 'B': 3.0, 'B-': 2.7, 'C+': 2.3, 'C': 2.0, 'C-': 1.7, 'D': 1.0, 'F': 0.0 };
            return scale[grade] || 0;
        }

        function getAcademicStatus(gpa) {
            if (gpa >= 3.5) return 'Excellent';
            if (gpa >= 3.0) return 'Good';
            if (gpa >= 2.0) return 'Satisfactory';
            return 'Probation';
        }

        // Data generation functions
    // Timetable is now loaded from Firebase Realtime Database

    // Sample messages removed — chat is driven by Firebase Realtime Database

    // Results are now loaded from Firebase Realtime Database

    // Fake user generators removed — users are loaded from Firebase

    // Attendance records are now loaded from Firebase Realtime Database

        function generateTeachingRecords() {
            return [
                { lecturer: 'Dr. Smith', course: 'Mathematics', date: '2023-10-16', duration: '2 hours', attendance: 85 },
                { lecturer: 'Prof. Johnson', course: 'Computer Science', date: '2023-10-17', duration: '1.5 hours', attendance: 92 },
                { lecturer: 'Dr. Lee', course: 'Physics', date: '2023-10-18', duration: '2 hours', attendance: 78 }
            ];
        }

    // Resources are now loaded from Firebase Realtime Database

        // Initialize the application when the page loads
        window.onload = initApp;
    </script>
</body>
<script>
// SPA Tab Navigation
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        const target = this.getAttribute('data-target');
        document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
        document.getElementById(target).classList.add('active');
    });
});

// Modal Handling
document.querySelectorAll('.close-modal').forEach(btn => {
    btn.addEventListener('click', function() {
        btn.closest('.modal').style.display = 'none';
    });
});
document.querySelectorAll('[data-modal]').forEach(el => {
    el.addEventListener('click', function() {
        const modalId = el.getAttribute('data-modal');
        document.getElementById(modalId).style.display = 'flex';
    });
});

// Login/Registration Toggle
const loginOptions = document.querySelectorAll('.login-option');
loginOptions.forEach(opt => {
    opt.addEventListener('click', function() {
        loginOptions.forEach(o => o.classList.remove('active'));
        this.classList.add('active');
        if (this.getAttribute('data-type') === 'register') {
            document.querySelector('.registration-form').style.display = 'block';
        } else {
            document.querySelector('.registration-form').style.display = 'none';
        }
    });
});

// Basic Login Validation (form-level validation kept, actual auth handled elsewhere)
document.querySelectorAll('.login-container form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        let valid = true;
        form.querySelectorAll('.form-group').forEach(group => {
            const input = group.querySelector('input,select');
            if (input && !input.value) {
                group.classList.add('error');
                valid = false;
            } else {
                group.classList.remove('error');
            }
        });
        // do not show simulated alerts here; authentication flow will handle UI state
    });
});

// Chat: push messages to Firebase Realtime Database
const chatForm = document.querySelector('.chat-input form');
if (chatForm) {
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const input = chatForm.querySelector('input');
        if (!input || !input.value.trim()) return;
        if (!state.currentUser) return alert('Please sign in to send messages');
        const newMessageRef = rtdb.ref('chatMessages').push();
        newMessageRef.set({
            text: input.value.trim(),
            sender: state.currentUser.name,
            senderId: state.currentUser.id,
            timestamp: Date.now()
        });
        input.value = '';
    });
}

// Notifications: real-time listener and UI
const bell = document.querySelector('.notification-bell');
const notifCountElem = document.querySelector('.notification-count');
const notificationsList = document.getElementById('notifications-list');
let unreadCount = 0;

function renderNotificationsList(items) {
    if (!notificationsList) return;
    notificationsList.innerHTML = '';
    const keys = Object.keys(items || {}).sort((a,b)=> (items[b].timestamp||0)-(items[a].timestamp||0));
    keys.forEach(k => {
        const n = items[k];
        const div = document.createElement('div');
        div.style.padding = '10px';
        div.style.borderBottom = '1px solid #eee';
        if (!n.read) div.style.background = '#eef6ff';
        div.innerHTML = `<div style="font-weight:600">${n.title || 'Notification'}</div><div style="font-size:0.9rem;color:#555">${n.message || ''}</div><div style="font-size:0.8rem;color:#999;margin-top:6px">${new Date(n.timestamp||0).toLocaleString()}</div>`;
        div.addEventListener('click', () => {
            // mark as read when clicked
            rtdb.ref('notifications/' + k).update({ read: true });
        });
        notificationsList.appendChild(div);
    });
}

// Mark all read button
const markAllBtn = document.getElementById('mark-all-read');
if (markAllBtn) {
    markAllBtn.addEventListener('click', () => {
        rtdb.ref('notifications').once('value', (snap) => {
            const items = snap.val() || {};
            Object.keys(items).forEach(k => {
                rtdb.ref('notifications/' + k).update({ read: true });
            });
        });
    });
}

// Listen for notifications for all users (filtering rules can be applied server-side)
rtdb.ref('notifications').on('value', (snapshot) => {
    const items = snapshot.val() || {};
    const unread = Object.values(items).filter(i => !i.read).length;
    unreadCount = unread;
    if (notifCountElem) {
        // store base notification unread count so private unread can be combined
        notifCountElem.setAttribute('data-base', String(unreadCount || 0));
        // compute visible text by combining with any private unread (subscribePrivateUnread will read data-base)
        const base = parseInt(notifCountElem.getAttribute('data-base') || '0') || 0;
        // If subscribePrivateUnread is active it will overwrite textContent; otherwise set to base
        const currentText = notifCountElem.textContent || '';
        if (!currentText || Number(currentText) === base) {
            notifCountElem.textContent = base > 0 ? base : '';
        }
    }
    renderNotificationsList(items);
});

if (bell) {
    bell.addEventListener('click', function() {
        document.getElementById('notifications-modal').style.display = 'flex';
    });
}

// Listen for timetable meta updates and refresh UI for non-admin users
rtdb.ref('meta/timetable/lastUpdate').on('value', (snapshot) => {
    const payload = snapshot.val();
    if (!payload) return;
    // show subtle toast
    const toast = document.createElement('div');
    toast.textContent = `Timetable ${payload.action || 'updated'}: ${payload.subject || ''} ${payload.time || ''}`;
    toast.style.position = 'fixed'; toast.style.right = '20px'; toast.style.bottom = '20px';
    toast.style.background = 'rgba(0,0,0,0.8)'; toast.style.color = 'white';
    toast.style.padding = '10px 14px'; toast.style.borderRadius = '6px';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);

    // Refresh timetable for students and lecturers
    if (state.currentUser && (state.currentUser.role === 'student' || state.currentUser.role === 'lecturer' || state.currentUser.role === 'admin')) {
        updateTimetable();
    }
});

// Helper: send a notification into RTDB
function sendNotification({title, message, targetUserId=null}){
    const nRef = rtdb.ref('notifications').push();
    nRef.set({
        title: title,
        message: message,
        target: targetUserId || 'all',
        read: false,
        timestamp: Date.now(),
        createdBy: state.currentUser ? state.currentUser.id : 'system'
    });
}

// Broadcast timetable change: write meta and send notification
function broadcastTimetableChange(program, action, subject, time) {
    try {
        const payload = { timestamp: Date.now(), program: program || 'all', action: action || '', subject: subject || '', time: time || '', by: state.currentUser ? state.currentUser.id : 'system' };
        rtdb.ref('meta/timetable/lastUpdate').set(payload);
        // send a generic notification to all or program-specific (can be filtered server-side)
        sendNotification({ title: `Timetable ${action}`, message: `${subject || 'Class'} ${action} at ${time || ''}`, targetUserId: program || null });
    } catch (e) { console.error('broadcastTimetableChange error', e); }
}

// Generic action buttons: prevent accidental simulated alerts. Specific actions should call real handlers.
document.querySelectorAll('.btn-primary, .btn-secondary').forEach(btn => {
    // keep for styling only; individual handlers are attached where needed
});

// Real-time user presence
function setUserOnlineStatus() {
    if (!state.currentUser) return;
    const userId = state.currentUser.id;
    const userRef = rtdb.ref('onlineUsers/' + userId);
    userRef.set({
        id: userId,
        name: state.currentUser.name,
        role: state.currentUser.role,
        timestamp: Date.now()
    });
    userRef.onDisconnect().remove();
}

function loadOnlineUsers() {
    const userCountElem = document.querySelector('.user-count');
    const userListElem = document.querySelector('.user-list');
    rtdb.ref('onlineUsers').on('value', (snapshot) => {
    const users = snapshot.val() || {};
    const userArr = Object.values(users);
    // If viewer is a student, hide admin accounts from the list
    const visibleArr = (state.currentUser && state.currentUser.role === 'student') ? userArr.filter(u => (u.role || '').toLowerCase() !== 'admin') : userArr;
    if (userCountElem) userCountElem.textContent = visibleArr.length;
        if (userListElem) {
            // Only update if user-list exists in chat section
            const classmatesList = userListElem.querySelector('h3') ? userListElem : null;
            if (classmatesList) {
                userListElem.querySelectorAll('.user-item').forEach(e => e.remove());
                visibleArr.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'user-item';
                    userDiv.setAttribute('data-user', user.id);
                    userDiv.innerHTML = `
                        <div class="user-avatar">${(user.name||'U')[0]}</div>
                        <div class="user-info">
                            <div class="user-name">${user.name}</div>
                            <div class="user-title">${user.role}</div>
                        </div>
                        <div class="user-status"></div>
                    `;
                    // add unread badge placeholder
                    const badge = document.createElement('div');
                    badge.className = 'private-unread-badge';
                    badge.style.display = 'none';
                    badge.textContent = '0';
                    userDiv.appendChild(badge);

                    // click handler opens private chat and clears unread for current user
                    userDiv.addEventListener('click', () => {
                        const token = user.id;
                        try {
                            if (state.currentUser && token) {
                                const chatId = getPrivateChatId(state.currentUser.id, token);
                                if (chatId) rtdb.ref(`privateUnread/${state.currentUser.id}/${chatId}`).remove();
                            }
                        } catch (e) {}
                        openPrivateChat(user.id);
                    });

                    userListElem.appendChild(userDiv);
                });
            }
        }
    });
}

// Render classmates from real users (populates .user-list within the chat section)
function renderClassmates(users) {
    const userListElem = document.querySelector('.user-list');
    if (!userListElem) return;
    // Remove existing user-items but keep header
    userListElem.querySelectorAll('.user-item').forEach(e => e.remove());

    const students = (users || []).filter(u => u.role === 'student');
    students.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.className = 'user-item';
        userDiv.setAttribute('data-user', user.id);
        userDiv.innerHTML = `
            <div class="user-avatar">${(user.name || 'U').charAt(0).toUpperCase()}</div>
            <div class="user-info">
                <div class="user-name">${user.name || ''}</div>
                <div class="user-title">${user.program || ''}</div>
            </div>
            <div class="user-status"></div>
        `;
    // attach unread badge placeholder
    const badge = document.createElement('div');
    badge.className = 'private-unread-badge';
    badge.style.display = 'none';
    badge.textContent = '0';
    userDiv.appendChild(badge);
        userListElem.appendChild(userDiv);
    });

    // Re-attach click handlers for newly created user items
    userListElem.querySelectorAll('.user-item').forEach(item => {
        item.addEventListener('click', function() {
            const token = this.getAttribute('data-user');
            // When opening a private chat via click, clear unread counter for that chat
            try {
                if (state.currentUser && token) {
                    const chatId = getPrivateChatId(state.currentUser.id, token);
                    if (chatId) rtdb.ref(`privateUnread/${state.currentUser.id}/${chatId}`).remove();
                }
            } catch (e) {}
            if (!token) return;
            // Resolve to id already stored in attribute
            openPrivateChat(token);
        });
    });
}

// Subscribe to private unread counters for the current user and update UI badges
function subscribePrivateUnreadForCurrentUser() {
    if (!state.currentUser || !state.currentUser.id) return;
    const me = state.currentUser.id;
    // detach previous listener if any
    try { if (state._privateUnreadListener) rtdb.ref(state._privateUnreadListener).off('value'); } catch (e) {}
    const refPath = `privateUnread/${me}`;
    state._privateUnreadListener = refPath;
    rtdb.ref(refPath).on('value', (snap) => {
        const obj = snap.val() || {};
        // Update per-user badges in the classmates list
        const userListElem = document.querySelector('.user-list');
        let total = 0;
        Object.keys(obj).forEach(chatId => {
            const entry = obj[chatId] || {};
            total += (entry.count || 0);
            // chatId is sorted combination of two user ids; determine the other participant
            const parts = chatId.split('__');
            const other = parts[0] === me ? parts[1] : parts[0];
            updateUserItemUnreadBadge(other, entry.count || 0);
        });
        // Update private message bell with total private unread
        const privateElem = document.querySelector('.private-count');
        if (privateElem) {
            privateElem.textContent = total > 0 ? (total > 99 ? '99+' : String(total)) : '';
        }
    });
}

// Update the unread badge for a specific user item
function updateUserItemUnreadBadge(userId, count) {
    if (!userId) return;
    const userItems = document.querySelectorAll('.user-item');
    userItems.forEach(ui => {
        if (ui.getAttribute('data-user') === String(userId)) {
            const badge = ui.querySelector('.private-unread-badge');
            if (badge) {
                if (count && count > 0) { badge.style.display = 'flex'; badge.textContent = String(count > 99 ? '99+' : count); }
                else { badge.style.display = 'none'; badge.textContent = '0'; }
            }
        }
    });
}

// Small toast helper
function showToast(text, ms = 3000) {
    const t = document.createElement('div');
    t.textContent = text;
    t.style.position = 'fixed'; t.style.right = '20px'; t.style.bottom = '20px';
    t.style.background = 'rgba(0,0,0,0.8)'; t.style.color = 'white';
    t.style.padding = '10px 14px'; t.style.borderRadius = '6px'; t.style.zIndex = 1100;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), ms);
}

// --- New chat niceties: emoji picker, typing indicator, reactions, conversations inbox ---

function initEmojiPicker() {
    const picker = document.getElementById('emoji-picker');
    if (!picker) return;
    // grouped emoji sets
    const groups = {
        'Smileys': ['😀','😃','😄','😁','😆','😅','😂','🤣','😊','😇','🙂','🙃','😉','😍','😘','😗','😙','😚','😋','😛'],
        'People': ['👋','🤚','🖐️','✋','👐','🤝','👍','👎','👏','🙌','🙏','💪','🤳','💃','🕺'],
        'Activities': ['⚽','🏀','🏈','⚾','🎾','🏐','🏉','🎱','🏓','🏸','🥊','🏆','🎮','🎲'],
        'Objects': ['🎧','🎤','📚','📎','📌','✂️','🔒','🔑','💡','🔋','📱','💻','⌚'],
        'Symbols': ['❤️','💔','✨','🔥','⭐','✔️','✖️','➕','➖','✔️','❗','❓','💯'],
        'Nature': ['🌱','🌿','☘️','🌵','🌳','🌴','🌻','🌸','🌼','🌺','🌊','🌧️']
    };
    const catsEl = document.getElementById('emoji-cats');
    const gridEl = document.getElementById('emoji-grid');
    const recentEl = document.getElementById('emoji-recent');
    const recentListEl = document.getElementById('emoji-recent-list');
    if (!catsEl || !gridEl) return;
    catsEl.innerHTML = '';
    gridEl.innerHTML = '';
    // load recent from localStorage
    let recent = [];
    try { recent = JSON.parse(localStorage.getItem('uv_recent_emoji')||'[]'); } catch(e) { recent = []; }
    function showCategory(cat) {
        gridEl.innerHTML = '';
        const arr = groups[cat] || [];
        arr.forEach(em => {
            const it = document.createElement('div'); it.className = 'emoji-item'; it.textContent = em;
            it.addEventListener('click', () => {
                const active = document.activeElement;
                let input = null;
                if (active && (active.id === 'message-input' || active.id === 'private-message-input')) input = active;
                if (!input) input = document.getElementById('message-input') || document.getElementById('private-message-input');
                if (!input) return;
                input.value = (input.value ? input.value + ' ' : '') + em;
                // update recent
                recent = [em].concat(recent.filter(x=>x!==em)).slice(0,8);
                try { localStorage.setItem('uv_recent_emoji', JSON.stringify(recent)); } catch(e){}
                renderRecent();
                const menu = document.getElementById('emoji-menu'); if (menu) menu.style.display = 'none';
                input.focus();
            });
            gridEl.appendChild(it);
        });
    }
    function renderCategories() {
        catsEl.innerHTML = '';
        Object.keys(groups).forEach((cat, idx) => {
            const b = document.createElement('div'); b.className = 'emoji-cat'; b.textContent = cat;
            if (idx === 0) b.classList.add('active');
            b.addEventListener('click', () => { document.querySelectorAll('.emoji-cat').forEach(x=>x.classList.remove('active')); b.classList.add('active'); showCategory(cat); });
            catsEl.appendChild(b);
        });
    }
    function renderRecent() {
        if (!recent || recent.length === 0) { recentEl.style.display = 'none'; return; }
        recentEl.style.display = 'block'; recentListEl.innerHTML = '';
        recent.forEach(em => { const s = document.createElement('span'); s.className = 'emoji-item'; s.textContent = em; s.addEventListener('click', () => {
            const active = document.activeElement; let input = null; if (active && (active.id === 'message-input' || active.id === 'private-message-input')) input = active; if (!input) input = document.getElementById('message-input') || document.getElementById('private-message-input'); if (!input) return; input.value = (input.value ? input.value + ' ' : '') + em; const menu = document.getElementById('emoji-menu'); if (menu) menu.style.display = 'none'; input.focus(); }); recentListEl.appendChild(s); });
    }
    renderCategories();
    showCategory(Object.keys(groups)[0]);
    renderRecent();

    // helper to show menu near button and focus appropriate input
    function toggleEmojiMenuFor(button, inputId) {
        const menu = document.getElementById('emoji-menu');
        if (!menu) return;
        if (menu.style.display === 'block') { menu.style.display = 'none'; return; }
        // position menu near button
        const rect = button.getBoundingClientRect();
        const viewportW = window.innerWidth || document.documentElement.clientWidth;
        const viewportH = window.innerHeight || document.documentElement.clientHeight;
        // default below-left of button
        let left = rect.left;
        let top = rect.bottom + 6;
        // if overflow right, move left
    const menuW = 260; const menuH = 220;
        if (left + menuW > viewportW) left = Math.max(8, viewportW - menuW - 8);
        if (top + menuH > viewportH) top = Math.max(8, rect.top - menuH - 8);
        menu.style.position = 'fixed';
        menu.style.left = left + 'px';
        menu.style.top = top + 'px';
        menu.style.display = 'block';
        // focus input if provided
        if (inputId) {
            const inp = document.getElementById(inputId);
            if (inp) inp.focus();
        }
    }

    const emojiBtn = document.getElementById('emoji-btn');
    if (emojiBtn) {
        emojiBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            toggleEmojiMenuFor(emojiBtn, 'message-input');
        });
    }
    const pemojiBtn = document.getElementById('private-emoji-btn');
    if (pemojiBtn) {
        pemojiBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            toggleEmojiMenuFor(pemojiBtn, 'private-message-input');
        });
    }

    // close on outside click
    document.addEventListener('click', (e) => {
        const menu = document.getElementById('emoji-menu');
        if (!menu) return;
        const target = e.target;
        if (!menu.contains(target) && target.id !== 'emoji-btn' && target.id !== 'private-emoji-btn') menu.style.display = 'none';
    });
}

function setTyping(isTyping, key) {
    try {
        if (!state.currentUser || !state.currentUser.id) return;
        const payload = { userId: state.currentUser.id, name: state.currentUser.name, timestamp: Date.now() };
        if (!key) key = 'group';
        const ref = rtdb.ref('typing/' + key + '/' + state.currentUser.id);
        if (isTyping) ref.set(payload);
        else ref.remove();
        // ensure removal on disconnect
        if (isTyping) ref.onDisconnect().remove();
    } catch (e) { console.warn('setTyping error', e); }
}

function subscribeTypingIndicators() {
    // subscribe to group typing
    rtdb.ref('typing/group').on('value', snap => {
        const obj = snap.val() || {};
        const names = Object.values(obj).map(o => o.name).slice(0,3);
        const el = document.getElementById('typing-indicator');
        if (el) el.textContent = names.length ? (names.join(', ') + (names.length===1? ' is typing...':' are typing...')) : '';
    });
}

// Reactions: toggles reaction for a message
function sendReaction(chatPath, messageId, emoji) {
    if (!chatPath || !messageId || !emoji || !state.currentUser) return;
    const ref = rtdb.ref(`${chatPath}/${messageId}/reactions/${emoji}/${state.currentUser.id}`);
    // toggle: if exists remove, else set
    ref.once('value').then(snap => {
        if (snap.exists()) ref.remove(); else ref.set({ userId: state.currentUser.id, name: state.currentUser.name, ts: Date.now() });
    }).catch(e => console.warn('reaction error', e));
}

// Render conversation list (private chats) with last message preview and unread
function renderConversations() {
    const list = document.getElementById('conversations-list');
    if (!list || !state.currentUser) return;
    list.innerHTML = '';
    // Simple approach: iterate privateUnread for current user to get chatIds with unread, and also scan privateChats for recent messages
    rtdb.ref('privateChats').orderByChild('timestamp').limitToLast(100).once('value').then(snap => {
        const chats = snap.val() || {};
        // build map chatId -> last message
        const map = {};
        Object.keys(chats).forEach(chatId => {
            const msgs = chats[chatId] || {};
            const last = Object.values(msgs).sort((a,b)=>a.timestamp-b.timestamp).slice(-1)[0];
            if (last) map[chatId] = last;
        });
        // sort by last timestamp desc
        const entries = Object.keys(map).map(cid => ({ cid, last: map[cid] })).sort((a,b)=> b.last.timestamp - a.last.timestamp);
        entries.forEach(e => {
            const parts = e.cid.split('__');
            const other = parts[0] === state.currentUser.id ? parts[1] : parts[0];
            const item = document.createElement('div');
            item.className = 'conv-item';
            item.innerHTML = `<div class="conv-avatar">${(e.last.sender||'U').charAt(0).toUpperCase()}</div><div class="conv-meta"><div class="conv-title">${e.last.sender}</div><div class="conv-sub">${(e.last.text||'')} · ${new Date(e.last.timestamp).toLocaleTimeString()}</div></div>`;
            item.addEventListener('click', () => {
                openPrivateChat(other);
            });
            list.appendChild(item);
        });
    }).catch(e=>console.warn('renderConversations error', e));
}

// wire reactions rendering inside createMessageElement: subscribe to reactions changes for visible chat
function subscribeReactionsForChat(chatPath) {
    if (!chatPath) return;
    try { if (state._reactionListener) rtdb.ref(state._reactionListener).off('value'); } catch(e){}
    state._reactionListener = chatPath;
    rtdb.ref(chatPath).on('value', snap => {
        // re-render messages if they include reactions
        // simplest: reload current messages view if open
        if (chatPath.startsWith('privateChats/') && state.currentPrivateChatId && (`privateChats/${state.currentPrivateChatId}` === chatPath)) {
            loadPrivateMessages(document.getElementById('private-chat-modal')?.getAttribute('data-recipient'));
        } else if (chatPath === 'chatMessages') {
            loadChatMessages();
        }
    });
}


// Admin: Manage Courses and Classes Modal
function showManageCoursesClassesModal() {
    let modal = document.getElementById('manage-courses-classes-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'manage-courses-classes-modal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width:520px;">
                <span class="close-modal" style="float:right;cursor:pointer;font-size:20px;">&times;</span>
                <h3>Manage Courses & Classes</h3>
                <div id="courses-list"></div>
                <h4>Add New Course</h4>
                <input type="text" id="new-course-id" placeholder="Course ID" style="width:30%;margin-right:5px;margin-bottom:5px;" />
                <input type="text" id="new-course-name" placeholder="Course Name" style="width:40%;margin-right:5px;margin-bottom:5px;" />
                <select id="new-course-program" style="width:24%;margin-bottom:5px;"><option value="">Program</option></select>
                <button id="add-course-btn">Add Course</button>
                <hr>
                <div id="classes-list"></div>
                <h4>Add New Class</h4>
                <input type="text" id="new-class-id" placeholder="Class ID" style="width:45%;margin-bottom:5px;" />
                <input type="text" id="new-class-name" placeholder="Class Name" style="width:45%;margin-bottom:5px;" />
                <button id="add-class-btn">Add Class</button>
            </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector('.close-modal').onclick = () => { modal.style.display = 'none'; };
        window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
    }
    // Render course list
    function renderCoursesList() {
        const listDiv = document.getElementById('courses-list');
        listDiv.innerHTML = '<h4>Courses</h4>';
        // populate program selector for creating course
        const progSelect = document.getElementById('new-course-program');
        if (progSelect) {
            progSelect.innerHTML = '<option value="">Program</option>';
            (state.programs || []).forEach(p => {
                const o = document.createElement('option'); o.value = p.id; o.textContent = p.name; progSelect.appendChild(o);
            });
        }
        (state.courses || []).forEach(course => {
            const programName = (state.programs || []).find(p => p.id === (course.program || ''))?.name || (course.program || 'Unassigned');
            const div = document.createElement('div');
            div.style.marginBottom = '6px';
            div.innerHTML = `<b>${course.id}</b>: ${course.name} <span style="color:#666">[${programName}]</span> <button data-id="${course.id}" class="edit-course-btn">Edit</button> <button data-id="${course.id}" class="delete-course-btn">Delete</button>`;
            listDiv.appendChild(div);
        });
        listDiv.querySelectorAll('.edit-course-btn').forEach(btn => {
            btn.onclick = function() {
                const cid = this.getAttribute('data-id');
                const course = (state.courses || []).find(c => c.id === cid) || {};
                const newName = prompt('Edit Course Name:', course.name || '');
                if (newName === null) return; // cancelled
                const newProgram = prompt('Edit Program ID (leave blank to keep current):', course.program || '');
                const updates = {};
                if (newName && newName.trim() !== course.name) updates.name = newName.trim();
                if (newProgram !== null) updates.program = newProgram.trim();
                if (Object.keys(updates).length > 0) {
                    rtdb.ref('courses/' + cid).update(updates);
                    sendNotification({ title: 'Course Updated', message: `${cid} updated` });
                }
            };
        });
        listDiv.querySelectorAll('.delete-course-btn').forEach(btn => {
            btn.onclick = function() {
                const cid = this.getAttribute('data-id');
                if (confirm('Delete this course?')) {
                    rtdb.ref('courses/' + cid).remove();
                }
            };
        });
    }
    renderCoursesList();
    document.getElementById('add-course-btn').onclick = function() {
        const id = document.getElementById('new-course-id').value.trim();
        const name = document.getElementById('new-course-name').value.trim();
        const program = document.getElementById('new-course-program').value || '';
        if (!id || !name) {
            alert('Enter both ID and Name');
            return;
        }
        rtdb.ref('courses/' + id).set({ id, name, program });
        document.getElementById('new-course-id').value = '';
        document.getElementById('new-course-name').value = '';
        document.getElementById('new-course-program').value = '';
    };
    rtdb.ref('courses').on('value', renderCoursesList);

    // Render class list
    function renderClassesList() {
        const listDiv = document.getElementById('classes-list');
        listDiv.innerHTML = '<h4>Classes</h4>';
        (state.classes || []).forEach(cls => {
            const div = document.createElement('div');
            div.style.marginBottom = '6px';
            div.innerHTML = `<b>${cls.id}</b>: ${cls.name} <button data-id="${cls.id}" class="edit-class-btn">Edit</button> <button data-id="${cls.id}" class="delete-class-btn">Delete</button>`;
            listDiv.appendChild(div);
        });
        listDiv.querySelectorAll('.edit-class-btn').forEach(btn => {
            btn.onclick = function() {
                const cid = this.getAttribute('data-id');
                const cls = (state.classes || []).find(c => c.id === cid) || {};
                const newName = prompt('Edit Class Name:', cls.name || '');
                if (newName === null) return;
                if (newName && newName.trim() !== cls.name) {
                    rtdb.ref('classes/' + cid).update({ name: newName.trim() });
                    sendNotification({ title: 'Class Updated', message: `${cid} updated` });
                }
            };
        });
        listDiv.querySelectorAll('.delete-class-btn').forEach(btn => {
            btn.onclick = function() {
                const cid = this.getAttribute('data-id');
                if (confirm('Delete this class?')) {
                    rtdb.ref('classes/' + cid).remove();
                }
            };
        });
    }
    renderClassesList();
    document.getElementById('add-class-btn').onclick = function() {
        const id = document.getElementById('new-class-id').value.trim();
        const name = document.getElementById('new-class-name').value.trim();
        if (!id || !name) {
            alert('Enter both ID and Name');
            return;
        }
        rtdb.ref('classes/' + id).set({ id, name });
        document.getElementById('new-class-id').value = '';
        document.getElementById('new-class-name').value = '';
    };
    rtdb.ref('classes').on('value', renderClassesList);
    modal.style.display = 'flex';
}

// Show detailed view of a timetable entry (non-blocking modal)
function showTimetableEntryDetails(entry) {
    let modal = document.getElementById('timetable-entry-details-modal');
    if (!modal) {
        modal = document.createElement('div'); modal.id = 'timetable-entry-details-modal'; modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width:520px;">
                <span class="close-modal" style="float:right;cursor:pointer;font-size:20px;">&times;</span>
                <h3 id="ted-title"></h3>
                <div id="ted-body"></div>
            </div>`;
        document.body.appendChild(modal);
        modal.querySelector('.close-modal').onclick = () => { modal.style.display = 'none'; };
        window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
    }
    document.getElementById('ted-title').textContent = entry.subject || 'Details';
    document.getElementById('ted-body').innerHTML = `
        <p><strong>Program:</strong> ${(state.programs || []).find(p => p.id === (entry.program || ''))?.name || entry.program || 'N/A'}</p>
        <p><strong>Day / Time:</strong> ${['Mon','Tue','Wed','Thu','Fri'][entry.day] || entry.day} ${entry.time || ''}</p>
        <p><strong>Room:</strong> ${entry.location || ''}</p>
        <p><strong>Lecturer:</strong> ${entry.lecturer || ''}</p>
        <p><strong>Status:</strong> ${entry.status || 'scheduled'}</p>
    `;
    modal.style.display = 'flex';
}

// Open Manage Timetable modal and prefill fields for editing
function openManageTimetableForEdit(key) {
    // Ensure manage modal exists
    showManageTimetableModal();
    // load entry and prefill the add/edit form
    rtdb.ref('timetable/' + key).once('value', snap => {
        const e = snap.val() || {};
        // set program, then populate subjects
        const prog = document.getElementById('tt-program');
        const subj = document.getElementById('tt-subject');
        const timeSel = document.getElementById('tt-time');
        if (prog) prog.value = e.program || '';
        populateSubjectSelectByProgram(subj, prog ? prog.value : '');
        if (subj) subj.value = e.subject || '';
        if (document.getElementById('tt-year')) document.getElementById('tt-year').value = e.year || '';
        if (document.getElementById('tt-semester')) document.getElementById('tt-semester').value = e.semester || '';
        if (document.getElementById('tt-day')) document.getElementById('tt-day').value = (typeof e.day !== 'undefined' && e.day !== null) ? e.day : '0';
        if (timeSel) timeSel.value = e.time || '';
        if (document.getElementById('tt-location')) document.getElementById('tt-location').value = e.location || '';
        if (document.getElementById('tt-lecturer')) document.getElementById('tt-lecturer').value = e.lecturer || '';
        if (document.getElementById('tt-status')) document.getElementById('tt-status').value = e.status || 'scheduled';

        // Modify Add button to perform update instead
        const addBtn = document.getElementById('add-timetable-entry-btn');
        addBtn.textContent = 'Save Changes';
        // remove previous handler
        addBtn.onclick = null;
        addBtn.onclick = function() {
            const subject = document.getElementById('tt-subject').value.trim();
            const program = document.getElementById('tt-program').value || '';
            const year = document.getElementById('tt-year').value.trim();
            const semester = document.getElementById('tt-semester').value.trim();
            const day = parseInt(document.getElementById('tt-day').value, 10);
            const time = document.getElementById('tt-time').value.trim();
            const location = document.getElementById('tt-location').value.trim();
            const lecturer = document.getElementById('tt-lecturer').value.trim();
            const status = document.getElementById('tt-status').value || 'scheduled';
            if (!subject || !time) { alert('Subject and Time required'); return; }
            // conflict detection: ensure no other entry uses same program/day/time/year/semester
            rtdb.ref('timetable').once('value', snap2 => {
                const all = snap2.val() || {};
                const conflict = Object.keys(all).find(k => k !== key && all[k].program === program && all[k].day == day && all[k].time === time && all[k].year == year && all[k].semester == semester);
                if (conflict) {
                    if (!confirm('This timeslot already has an entry. Overwrite?')) return;
                }
                const updates = { subject, program, year, semester, day, time, location, lecturer, status };
                rtdb.ref('timetable/' + key).update(updates);
                sendNotification({ title: 'Timetable Updated', message: `${subject} updated` });
                broadcastTimetableChange(program || 'all', 'Updated', subject, updates.time || '');
                // restore add handler
                addBtn.textContent = 'Add Entry';
                // reattach original add handler
                document.getElementById('add-timetable-entry-btn').onclick = function() {
                    const subject = document.getElementById('tt-subject').value.trim();
                    const program = document.getElementById('tt-program').value || '';
                    const year = document.getElementById('tt-year').value.trim();
                    const semester = document.getElementById('tt-semester').value.trim();
                    const day = parseInt(document.getElementById('tt-day').value, 10);
                    const time = document.getElementById('tt-time').value.trim();
                    const location = document.getElementById('tt-location').value.trim();
                    const lecturer = document.getElementById('tt-lecturer').value.trim();
                    const status = document.getElementById('tt-status').value || 'scheduled';
                    if (!subject || !time) { alert('Subject and Time are required'); return; }
                    const newEntry = { subject, program, year, semester, day, time, location, lecturer, status };
                    rtdb.ref('timetable').push(newEntry);
                    sendNotification({ title: 'Timetable Entry Added', message: `${subject} on ${time}` });
                    broadcastTimetableChange(program || 'all', 'Added', subject, time);
                    // Clear inputs
                    document.getElementById('tt-subject').value = '';
                    document.getElementById('tt-program').value = '';
                    document.getElementById('tt-year').value = '';
                    document.getElementById('tt-semester').value = '';
                    document.getElementById('tt-day').value = '0';
                    document.getElementById('tt-time').value = '';
                    document.getElementById('tt-location').value = '';
                    document.getElementById('tt-lecturer').value = '';
                };
                // re-render
                rtdb.ref('timetable').once('value', renderTimetableList);
            });
        };
    });
}

// Add button for admin to open modal (e.g. in timetable controls)
if (state.currentUser && state.currentUser.role === 'admin') {
    let timetableTools = document.querySelector('.timetable-actions');
    if (timetableTools && !document.getElementById('manage-courses-classes-btn')) {
        const btn = document.createElement('button');
        btn.id = 'manage-courses-classes-btn';
        btn.textContent = 'Manage Courses & Classes';
        btn.style.marginLeft = '10px';
        btn.onclick = showManageCoursesClassesModal;
        timetableTools.appendChild(btn);
    }

    // Add Manage Timetable button for admins
    if (timetableTools && !document.getElementById('manage-timetable-btn')) {
        const tbtn = document.createElement('button');
        tbtn.id = 'manage-timetable-btn';
        tbtn.textContent = 'Manage Timetable';
        tbtn.style.marginLeft = '10px';
        tbtn.onclick = showManageTimetableModal;
        timetableTools.appendChild(tbtn);
    }
}

// Admin: Manage Timetable Modal (create / edit / delete timetable entries)
function showManageTimetableModal() {
    let modal = document.getElementById('manage-timetable-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'manage-timetable-modal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width:720px;">
                <span class="close-modal" style="float:right;cursor:pointer;font-size:20px;">&times;</span>
                <h3>Manage Timetable</h3>
                <div id="timetable-entries-list" style="max-height:300px;overflow:auto;margin-bottom:10px;"></div>
                <h4>Add / Create Timetable Entry</h4>
                <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;">
                    <select id="tt-program" style="width:18%;"><option value="">Program</option></select>
                    <select id="tt-subject" style="width:22%;"><option value="">Subject / Course</option></select>
                    <input type="text" id="tt-year" placeholder="Year" style="width:10%;" />
                    <input type="text" id="tt-semester" placeholder="Semester" style="width:10%;" />
                    <select id="tt-day" style="width:10%;"><option value="0">Mon</option><option value="1">Tue</option><option value="2">Wed</option><option value="3">Thu</option><option value="4">Fri</option></select>
                    <select id="tt-time" style="width:20%;"><option value="">Time</option></select>
                    <input type="text" id="tt-location" placeholder="Room / Location" style="width:22%;" />
                    <input type="text" id="tt-lecturer" placeholder="Lecturer" style="width:22%;" />
                    <select id="tt-status" style="width:20%;"><option value="scheduled">scheduled</option><option value="ongoing">ongoing</option><option value="cancelled">cancelled</option><option value="makeup">makeup</option></select>
                </div>
                <div style="margin-top:8px;"><button id="add-timetable-entry-btn">Add Entry</button></div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector('.close-modal').onclick = () => { modal.style.display = 'none'; };
        window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
    }

    const timeSlots = [
        '9:00 - 10:00', '10:00 - 11:00', '11:00 - 12:00',
        '12:00 - 13:00', '13:00 - 14:00', '14:00 - 15:00'
    ];

    function populateTimeSelect(selectElem) {
        if (!selectElem) return;
        selectElem.innerHTML = '<option value="">Time</option>';
        timeSlots.forEach(t => {
            const o = document.createElement('option'); o.value = t; o.textContent = t; selectElem.appendChild(o);
        });
    }

    function populateProgramSelect(selectElem) {
        if (!selectElem) return;
        selectElem.innerHTML = '<option value="">Program</option>';
        (state.programs || []).forEach(p => {
            const o = document.createElement('option'); o.value = p.id; o.textContent = p.name; selectElem.appendChild(o);
        });
    }

    function populateSubjectSelectByProgram(subjectSelect, programId) {
        if (!subjectSelect) return;
        subjectSelect.innerHTML = '<option value="">Subject / Course</option>';
        const filtered = (state.courses || []).filter(c => !programId || (c.program || '') === programId);
        filtered.forEach(c => {
            const o = document.createElement('option'); o.value = c.id || c.name; o.textContent = `${c.id || ''} ${c.name || c.id || ''}`.trim(); subjectSelect.appendChild(o);
        });
    }

    function renderTimetableList(snapshot) {
        const container = document.getElementById('timetable-entries-list');
        container.innerHTML = '';
        const timetable = (snapshot && snapshot.val) ? (snapshot.val() || {}) : ({});
        // If called without snapshot, fetch once
        if (!snapshot) {
            rtdb.ref('timetable').once('value', renderTimetableList);
            return;
        }
        const dayNames = ['Mon','Tue','Wed','Thu','Fri'];
        Object.entries(timetable).forEach(([key, entry]) => {
            const div = document.createElement('div');
            div.style.borderBottom = '1px solid #eee';
            div.style.padding = '6px 4px';
            const progName = (state.programs || []).find(p => p.id === (entry.program || ''))?.name || (entry.program || 'Unassigned');
            const dayLabel = (typeof entry.day !== 'undefined' && entry.day !== null) ? (dayNames[entry.day] || entry.day) : '';
            div.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div style="flex:1">
                        <strong>${entry.subject || ''}</strong> <span style="color:#666">[${progName}]</span><br>
                        ${dayLabel} ${entry.time || ''} | Year:${entry.year || ''} Sem:${entry.semester || ''} | Room:${entry.location || ''} | Lecturer:${entry.lecturer || ''} | Status:${entry.status || ''}
                    </div>
                    <div style="margin-left:8px;white-space:nowrap;">
                        <button data-key="${key}" class="edit-tt-btn">Edit</button>
                        <button data-key="${key}" class="delete-tt-btn">Delete</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });

        // Attach handlers
        // Edit handler: show inline edit form
        container.querySelectorAll('.edit-tt-btn').forEach(btn => {
            btn.onclick = function() {
                const key = this.getAttribute('data-key');
                const parentDiv = this.closest('div');
                rtdb.ref('timetable/' + key).once('value', snap => {
                    const e = snap.val() || {};
                    // create edit form
                    const editForm = document.createElement('div');
                    editForm.style.display = 'flex';
                    editForm.style.flexWrap = 'wrap';
                    editForm.style.gap = '6px';
                    editForm.style.alignItems = 'center';
                    editForm.innerHTML = `
                        <select class="edit-tt-program" style="width:18%;"><option value="">Program</option></select>
                        <select class="edit-tt-subject" style="width:22%;"><option value="">Subject / Course</option></select>
                        <input class="edit-tt-year" placeholder="Year" style="width:10%;" />
                        <input class="edit-tt-semester" placeholder="Semester" style="width:10%;" />
                        <select class="edit-tt-day" style="width:10%;"><option value="0">Mon</option><option value="1">Tue</option><option value="2">Wed</option><option value="3">Thu</option><option value="4">Fri</option></select>
                        <select class="edit-tt-time" style="width:20%;"><option value="">Time</option></select>
                        <input class="edit-tt-location" placeholder="Room / Location" style="width:22%;" />
                        <input class="edit-tt-lecturer" placeholder="Lecturer" style="width:22%;" />
                        <select class="edit-tt-status" style="width:20%;"><option value="scheduled">scheduled</option><option value="ongoing">ongoing</option><option value="cancelled">cancelled</option><option value="makeup">makeup</option></select>
                        <div style="width:100%;margin-top:6px;">
                            <button class="save-edit-tt">Save</button>
                            <button class="cancel-edit-tt">Cancel</button>
                        </div>
                    `;
                    // replace parent div content
                    parentDiv.style.display = 'none';
                    parentDiv.parentNode.insertBefore(editForm, parentDiv.nextSibling);

                    // populate selects
                    populateProgramSelect(editForm.querySelector('.edit-tt-program'));
                    populateSubjectSelectByProgram(editForm.querySelector('.edit-tt-subject'), e.program || '');
                    populateTimeSelect(editForm.querySelector('.edit-tt-time'));

                    // set values
                    editForm.querySelector('.edit-tt-program').value = e.program || '';
                    editForm.querySelector('.edit-tt-subject').value = e.subject || '';
                    editForm.querySelector('.edit-tt-year').value = e.year || '';
                    editForm.querySelector('.edit-tt-semester').value = e.semester || '';
                    editForm.querySelector('.edit-tt-day').value = (typeof e.day !== 'undefined' && e.day !== null) ? e.day : '0';
                    editForm.querySelector('.edit-tt-time').value = e.time || '';
                    editForm.querySelector('.edit-tt-location').value = e.location || '';
                    editForm.querySelector('.edit-tt-lecturer').value = e.lecturer || '';
                    editForm.querySelector('.edit-tt-status').value = e.status || 'scheduled';

                    // change subject list when program changes
                    editForm.querySelector('.edit-tt-program').addEventListener('change', (ev) => {
                        populateSubjectSelectByProgram(editForm.querySelector('.edit-tt-subject'), ev.target.value);
                    });

                    // save
                    editForm.querySelector('.save-edit-tt').onclick = function() {
                        const updates = {
                            program: editForm.querySelector('.edit-tt-program').value || '',
                            subject: editForm.querySelector('.edit-tt-subject').value || editForm.querySelector('.edit-tt-subject').value,
                            year: editForm.querySelector('.edit-tt-year').value || '',
                            semester: editForm.querySelector('.edit-tt-semester').value || '',
                            day: parseInt(editForm.querySelector('.edit-tt-day').value, 10),
                            time: editForm.querySelector('.edit-tt-time').value || '',
                            location: editForm.querySelector('.edit-tt-location').value || '',
                            lecturer: editForm.querySelector('.edit-tt-lecturer').value || '',
                            status: editForm.querySelector('.edit-tt-status').value || 'scheduled'
                        };
                        rtdb.ref('timetable/' + key).update(updates);
                        sendNotification({ title: 'Timetable Updated', message: `${updates.subject} updated` });
                        // remove form and re-render
                        editForm.remove();
                        parentDiv.style.display = '';
                        rtdb.ref('timetable').once('value', renderTimetableList);
                    };

                    // cancel
                    editForm.querySelector('.cancel-edit-tt').onclick = function() {
                        editForm.remove();
                        parentDiv.style.display = '';
                    };
                });
            };
        });

        container.querySelectorAll('.delete-tt-btn').forEach(btn => {
            btn.onclick = function() {
                const key = this.getAttribute('data-key');
                if (confirm('Delete this timetable entry?')) {
                    rtdb.ref('timetable/' + key).remove();
                }
            };
        });
    }

    // Populate program select and wire subject/time dependencies for adding
    const progSelect = document.getElementById('tt-program');
    const subjSelect = document.getElementById('tt-subject');
    const timeSelect = document.getElementById('tt-time');
    if (progSelect) {
        populateProgramSelect(progSelect);
        // when program changes, update subject list
        progSelect.addEventListener('change', (e) => {
            populateSubjectSelectByProgram(subjSelect, e.target.value);
        });
    }
    if (subjSelect) {
        // initial population (no program selected)
        populateSubjectSelectByProgram(subjSelect, progSelect ? progSelect.value : '');
    }
    if (timeSelect) {
        populateTimeSelect(timeSelect);
    }

    // Add entry handler
    document.getElementById('add-timetable-entry-btn').onclick = function() {
        const subject = document.getElementById('tt-subject').value.trim();
        const program = document.getElementById('tt-program').value || '';
        const year = document.getElementById('tt-year').value.trim();
        const semester = document.getElementById('tt-semester').value.trim();
        const day = parseInt(document.getElementById('tt-day').value, 10);
        const time = document.getElementById('tt-time').value.trim();
        const location = document.getElementById('tt-location').value.trim();
        const lecturer = document.getElementById('tt-lecturer').value.trim();
        const status = document.getElementById('tt-status').value || 'scheduled';
        if (!subject || !time) {
            alert('Subject and Time are required');
            return;
        }
        const newEntry = { subject, program, year, semester, day, time, location, lecturer, status };
        rtdb.ref('timetable').push(newEntry);
        sendNotification({ title: 'Timetable Entry Added', message: `${subject} on ${time}` });
        // Clear inputs
        document.getElementById('tt-subject').value = '';
        document.getElementById('tt-program').value = '';
        document.getElementById('tt-year').value = '';
        document.getElementById('tt-semester').value = '';
        document.getElementById('tt-day').value = '0';
        document.getElementById('tt-time').value = '';
        document.getElementById('tt-location').value = '';
        document.getElementById('tt-lecturer').value = '';
    };

    // Listen for timetable changes to render list
    rtdb.ref('timetable').on('value', renderTimetableList);
    // Initial render
    rtdb.ref('timetable').once('value', renderTimetableList);

    modal.style.display = 'flex';
}
</script>
</html>